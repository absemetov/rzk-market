var e=require("firebase-functions"),t=require("firebase-admin"),a=require("telegraf"),r=require("algoliasearch"),o=require("google-spreadsheet"),s=require("validatorjs"),c=require("googleapis"),i=require("cyrillic-to-translit-js"),n=require("fs"),d=require("path"),l=require("os"),u=(require("https"),require("axios")),p=require("firebase-admin/app"),m=require("currency-codes"),$=require("moment"),b=require("express"),h=require("express-handlebars"),f=require("crypto"),g=require("jsonwebtoken"),w=require("cookie-parser"),y=require("busboy"),_=require("cors"),I=require("telegraf-i18n");function j(e,t,a,r){Object.defineProperty(e,t,{get:a,set:r,enumerable:!0,configurable:!0})}var k="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},N={},x={},R=k.parcelRequiref384;null==R&&((R=function(e){if(e in N)return N[e].exports;if(e in x){var t=x[e];delete x[e];var a={id:e,exports:{}};return N[e]=a,t.call(a.exports,a,a.exports),a.exports}var r=new Error("Cannot find module '"+e+"'");throw r.code="MODULE_NOT_FOUND",r}).register=function(e,t){x[e]=t},k.parcelRequiref384=R),R.register("2WYzv",(function(o,s){var c,i,n,d,l,u,p,m,$,b;j(o.exports,"notifyNewUser",(()=>c),(e=>c=e)),j(o.exports,"notifyNewOrder",(()=>i),(e=>i=e)),j(o.exports,"notifyNewCart",(()=>n),(e=>n=e)),j(o.exports,"productCreate",(()=>d),(e=>d=e)),j(o.exports,"productUpdate",(()=>l),(e=>l=e)),j(o.exports,"productDelete",(()=>u),(e=>u=e)),j(o.exports,"catalogCreate",(()=>p),(e=>p=e)),j(o.exports,"catalogUpdate",(()=>m),(e=>m=e)),j(o.exports,"catalogDelete",(()=>$),(e=>$=e)),j(o.exports,"productsUpload",(()=>b),(e=>b=e));var h=R("hvq1b").uploadProducts,f=R("3qHa4"),g=f.store,w=f.photoCheckUrl;const y=new(0,a.Telegraf)(process.env.BOT_TOKEN,{handlerTimeout:54e4}),_=t.storage().bucket(),I=r(process.env.ALGOLIA_ID,process.env.ALGOLIA_ADMIN_KEY),k=I.initIndex(`${process.env.ALGOLIA_PREFIX}products`),N=I.initIndex(`${process.env.ALGOLIA_PREFIX}catalogs`);c=e.region("europe-central2").firestore.document("users/{userId}").onCreate((async(e,t)=>{const a=e.data(),r=t.params.userId;return await y.telegram.sendMessage(94899148,`<b>New subsc! <a href="tg://user?id=${r}">${r}</a>\nMessage: ${a.message}</b>`,{parse_mode:"html"}),e.ref.set({createdAt:Math.floor(Date.now()/1e3)},{merge:!0})})),i=e.region("europe-central2").firestore.document("objects/{objectId}/orders/{orderId}").onCreate((async(e,t)=>{const a=e.data(),r=t.params.orderId;return await y.telegram.sendMessage(94899148,`<b>New order from <a href="tg://user?id=${a.userId}">${a.lastName} ${a.firstName}</a>\nObject ${a.objectName} from ${a.fromBot?"BOT":"SITE"}\nOrder ${a.userId}-${a.orderNumber}\n<a href="https://${process.env.BOT_SITE}/o/${a.objectId}/s/${r}">https://${process.env.BOT_SITE}/o/${a.objectId}/s/${r}</a></b>`,{parse_mode:"html"}),null})),n=e.region("europe-central2").firestore.document("objects/{objectId}/carts/{cartId}").onCreate((async(e,t)=>{const a=t.params.objectId,r=t.params.cartId;await y.telegram.sendMessage(94899148,`<b>New cart! <a href="https://${process.env.BOT_SITE}/o/${a}/share-cart/${r}">https://${process.env.BOT_SITE}/o/${a}/share-cart/${r}</a></b>`,{parse_mode:"html"});const o=e.data();return e.ref.set({createdAt:o.updatedAt},{merge:!0})})),d=e.region("europe-central2").firestore.document("objects/{objectId}/products/{productId}").onCreate((async(e,t)=>{const a=e.data(),r=t.params.productId,o=t.params.objectId,s={objectID:`${o}-${r}`,name:a.name,orderNumber:a.orderNumber,productId:r,seller:a.objectName,sellerId:o};a.brand&&(s.brand=a.brand),a.tagsNames&&(s.subCategory=a.tagsNames.map((e=>e.name)));const c=a.catalogsNamePath.split("#"),i=[];return c.forEach(((e,t)=>{i.push(e),s[`categories.lvl${t}`]=i.join(" > ")})),await k.saveObject(s),e.ref.set({createdAt:a.updatedAt},{merge:!0})})),l=e.region("europe-central2").firestore.document("objects/{objectId}/products/{productId}").onUpdate((async(e,t)=>{const a=e.after.data(),r=t.params.objectId,o=t.params.productId,s={objectID:`${r}-${o}`,name:a.name,orderNumber:a.orderNumber,productId:o,seller:a.objectName,sellerId:r};if(a.brand&&(s.brand=a.brand),a.tagsNames&&(s.subCategory=a.tagsNames.map((e=>e.name))),a.mainPhoto)for(const e of[1,2]){const t=await w(`photos/o/${r}/p/${o}/${a.mainPhoto}/${e}.jpg`,!!a.mainPhoto);t?s[`img${e}`]=t:await y.telegram.sendMessage(94899148,`Photo load error productId: ${o} zoom: ${e}`,{parse_mode:"html"})}const c=a.catalogsNamePath.split("#"),i=[];return c.forEach(((e,t)=>{i.push(e),s[`categories.lvl${t}`]=i.join(" > ")})),await k.saveObject(s),null})),u=e.region("europe-central2").firestore.document("objects/{objectId}/products/{productId}").onDelete((async(e,t)=>{const a=t.params.objectId,r=t.params.productId;return await k.deleteObject(`${a}-${r}`),await _.deleteFiles({prefix:`photos/o/${a}/p/${r}`}),null})),p=e.region("europe-central2").firestore.document("objects/{objectId}/catalogs/{catalogId}").onCreate((async(e,t)=>{const a=e.data(),r={objectID:t.params.catalogId,name:a.name,orderNumber:a.orderNumber,hierarchicalUrl:a.hierarchicalUrl};return await N.saveObject(r),e.ref.set({createdAt:a.updatedAt},{merge:!0})})),m=e.region("europe-central2").firestore.document("objects/{objectId}/catalogs/{catalogId}").onUpdate((async(e,t)=>{const a=e.after.data(),r=t.params.catalogId,o=t.params.objectId,s={objectID:r,name:a.name,orderNumber:a.orderNumber,hierarchicalUrl:a.hierarchicalUrl};if(a.photoId)for(const e of[1,2]){const t=await w(`photos/o/${o}/c/${r}/${a.photoId}/${e}.jpg`,!0);t?s[`img${e}`]=t:await y.telegram.sendMessage(94899148,`Photo load error catalogId: ${r} zoom: ${e}`,{parse_mode:"html"})}return await N.saveObject(s),null})),$=e.region("europe-central2").firestore.document("objects/{objectId}/catalogs/{catalogId}").onDelete((async(e,t)=>{const a=t.params.objectId,r=t.params.catalogId;return await N.deleteObject(r),await _.deleteFiles({prefix:`photos/o/${a}/c/${r}`}),null}));b=e.region("europe-central2").runWith({timeoutSeconds:540,memory:"1GB"}).firestore.document("objects/{objectId}").onUpdate((async(e,t)=>{const a=t.params.objectId,r=e.after.data(),o=e.before.data();if(r.uploadProductsStart==o.uploadProductsStart)return null;const s=await g.findRecord("users/94899148","session"),c=Math.floor(new Date/1e3);if(s.uploading&&Math.floor(new Date/1e3)-s.uploadStartAt<540)await y.telegram.sendMessage(94899148,"<b>Products loading...</b>",{parse_mode:"html"});else{await g.createRecord("users/94899148",{session:{uploading:!0,uploadStartAt:c}});try{await h(y.telegram,a,r.sheetId)}catch(e){await g.createRecord("users/94899148",{session:{uploading:!1}}),await y.telegram.sendMessage(94899148,`Sheet ${e}`,{parse_mode:"html"})}await g.createRecord("users/94899148",{session:{uploading:!1}})}return null}))})),R.register("hvq1b",(function(e,a){var r,n,d;j(e.exports,"uploadForm",(()=>r),(e=>r=e)),j(e.exports,"uploadActions",(()=>n),(e=>n=e)),j(e.exports,"uploadProducts",(()=>d),(e=>d=e));var l=o.GoogleSpreadsheet,u=R("aoboX"),p=c.google,m=R("3qHa4"),$=m.store,b=m.roundNumber,h=m.photoCheckUrl;const f=new i,g=new i({preset:"uk"}),w=async(e,a,r)=>{const o=t.firestore().batch(),s=await t.firestore().collection("objects").doc(a).collection("products").where("updatedAt","<",r).limit(500).get();s.forEach((e=>{o.delete(e.ref)})),await o.commit(),s.size&&await e.sendMessage(94899148,`<b>${s.size} products deleted</b>`,{parse_mode:"html"});const c=t.firestore().batch(),i=await t.firestore().collection("objects").doc(a).collection("catalogs").where("updatedAt","<",r).limit(500).get();i.forEach((e=>{c.delete(e.ref)})),await c.commit(),i.size&&await e.sendMessage(94899148,`<b>${i.size} catalogs deleted</b>`,{parse_mode:"html"})},y=[];y.push((async(e,t)=>{if("upload"!==e.state.routeName)return t();{const t=e.state.param,a=e.state.params.get("todo"),r=await $.findRecord(`objects/${t}`);let o="";if("updateObject"===a||"uploadProducts"===a)o=r.sheetId;else{o=(await $.findRecord(`users/${e.from.id}`,"session")).sheetId}try{if("uploadProducts"===a){await e.replyWithHTML(`Начинаем загрузку товаров ${r.name}\n`);const a=Math.floor(Date.now()/1e3);return await $.createRecord(`objects/${t}`,{uploadProductsStart:a}),void await e.answerCbQuery()}const c=new l(o);await c.useServiceAccountAuth(u,"nadir@absemetov.org.ua"),await c.loadInfo();const i=c.sheetsByTitle.info;await i.loadCells("B1:B9");const n=i.getCellByA1("B1").value,d=i.getCellByA1("B2").value,p=i.getCellByA1("B3").value,m=i.getCellByA1("B4").value,h=m&&m.toString().split("#").map((e=>`${process.env.BOT_PHONECODE}${e.trim()}`)),f=i.getCellByA1("B5").value,g=b(i.getCellByA1("B6").value),w=b(i.getCellByA1("B7").value),y=b(i.getCellByA1("B8").value),_=b(i.getCellByA1("B9").value);let I="";const j={id:n,name:d,description:p,phoneArray:h,address:f,USD:g,EUR:w,UAH:y,RUB:_},k={id:"required|alpha_dash|max:9",name:"required|string",description:"required|string",phoneArray:"required","phoneArray.*":["required",`regex:/${process.env.BOT_PHONEREGEXP}`],address:"required|string",USD:"required|numeric",EUR:"required|numeric",UAH:"required|numeric",RUB:"required|numeric"},N=new s(j,k,{regex:`The :attribute phone number is not in the format ${process.env.BOT_PHONETEMPLATE}`});if(N.fails()){let e="";for(const[t,a]of Object.entries(N.errors.all()))e+=`field <b>${t}</b> => <b>${a}</b>\n`;throw new Error(e)}"createObject"!==a&&"updateObject"!==a||(await $.createRecord(`objects/${t}`,{name:d,description:p,phoneArray:h,address:f,sheetId:o,currencies:{USD:g,EUR:w,UAH:y,RUB:_}}),I=r?`Данные обновлены ${r.name} /objects`:`Объект ${d} создан! /objects`),await e.replyWithHTML(I)}catch(t){await e.replyWithMarkdown(`Sheet ${t}`)}await e.answerCbQuery()}}));y.push((async(e,t)=>{if("uploadMerch"!==e.state.routeName)return t();{const t=e.state.param,a=e.state.params.get("o"),r=await $.findRecord(`objects/${a}`),o=await $.findRecord(`objects/${a}/products/${t}`);let s=null;o.mainPhoto&&(s=`photos/o/${a}/p/${o.id}/${o.mainPhoto}/2.jpg`);const c=await h(s),i=p.content("v2.1"),n=new p.auth.JWT({keyFile:"./rzk-com-ua-d1d3248b8410.json",scopes:["https://www.googleapis.com/auth/content"],subject:"nadir@absemetov.org.ua"});p.options({auth:n});const d=await i.products.insert({merchantId:"120890507",resource:{channel:"online",contentLanguage:"uk",offerId:o.id,targetCountry:"UA",title:o.name,description:"Rzk.com.ua - Каждая вторая розетка в Украине будет куплена у нас!",link:`https://rzk.com.ua/o/${a}/p/${o.id}`,imageLink:c,availability:"in stock",condition:"new",price:{value:b(o.price*r.currencies[o.currency]),currency:"UAH"}}});console.log(d.data),await e.answerCbQuery()}})),r=async(e,t)=>{const a=new l(t);try{await a.useServiceAccountAuth(u,"nadir@absemetov.org.ua"),await a.loadInfo();const t=a.sheetsByTitle.info;await t.loadCells("B1:B9");const r=t.getCellByA1("B1").value,o=t.getCellByA1("B2").value,c=t.getCellByA1("B3").value,i=t.getCellByA1("B4").value,n=i&&i.toString().split("#").map((e=>`${process.env.BOT_PHONECODE}${e.trim()}`)),d=t.getCellByA1("B5").value,l=b(t.getCellByA1("B6").value),p=b(t.getCellByA1("B7").value),m=b(t.getCellByA1("B8").value),h=b(t.getCellByA1("B9").value);let f="";const g={id:r,name:o,description:c,phoneArray:n,address:d,USD:l,EUR:p,UAH:m,RUB:h},w={id:"required|alpha_dash|max:9",name:"required|string",description:"required|string",phoneArray:"required","phoneArray.*":["required",`regex:/${process.env.BOT_PHONEREGEXP}`],address:"required|string",USD:"required|numeric",EUR:"required|numeric",UAH:"required|numeric",RUB:"required|numeric"},y=new s(g,w,{regex:`The :attribute phone number is not in the format ${process.env.BOT_PHONETEMPLATE}`});if(y.fails()){let e="";for(const[t,a]of Object.entries(y.errors.all()))e+=`field <b>${t}</b> => <b>${a}</b> \n`;throw new Error(e)}f=`Sheet name: <b>${a.title}</b>\nid: <b>${r}</b>\nname: <b>${o}</b>\ndescription: <b>${c}</b>\nphoneArray: <b>${n.join()}</b>\naddress: <b>${d}</b>\n`;const _=await $.findRecord(`objects/${r}`),I=[];let j="";j=_?"Обновить":"Создать",I.push([{text:`${j} объект ${o}`,callback_data:`upload/${r}?todo=createObject`}]),await e.replyWithHTML(f,{reply_markup:{inline_keyboard:I}})}catch(t){await e.replyWithMarkdown(`Sheet ${t}`)}},n=y,d=async(e,a,r)=>{const o=await $.findRecord(`objects/${a}`),c=new Date,i=Math.floor(c/1e3),n=500,d=new Map,p=new Set,m=new Map;let h=t.firestore().batch(),y=0;const _=new l(r);await _.useServiceAccountAuth(u,"nadir@absemetov.org.ua"),await _.loadInfo();const I=_.sheetsByTitle.products;await e.sendMessage(94899148,`<b>Loading goods from ${_.title}\nCount rows: ${I.rowCount}</b>`,{parse_mode:"html"});const j=I.rowCount;for(let r=1;r<j;r+=n){const c=t.firestore().batch();await I.loadCells({startRowIndex:r,endRowIndex:r+n,startColumnIndex:0,endColumnIndex:9});for(let e=r;e<r+n&&e<j;e++){const r={ID:I.getCell(e,0).value?I.getCell(e,0).value.toString():I.getCell(e,0).value,NAME:I.getCell(e,1).value?I.getCell(e,1).value.trim():I.getCell(e,1).value,PURCHASE_PRICE:I.getCell(e,2).value,PRICE:I.getCell(e,3).value,CURRENCY:I.getCell(e,4).value,UNIT:I.getCell(e,5).value,GROUP:I.getCell(e,6).value,TAGS:I.getCell(e,7).value,BRAND:I.getCell(e,8).value};if(r.ID&&r.NAME){const l=r.GROUP?r.GROUP.split("#").map(((e,t,a)=>{let r=null,o=null,s=e.trim();if(0!==t){const e=a[t-1].trim(),r=e.match(/(.+)\[([[a-zA-Z0-9-_]+)\]$/);o=r?r[2].trim():g.transform(f.transform(e,"-")).toLowerCase()}const c=e.match(/(.+)\[([[a-zA-Z0-9-_]+)\]$/);return c?(s=c[1].trim(),r=c[2].trim()):r=g.transform(f.transform(s,"-")).toLowerCase(),{id:r,name:s,parentId:o}})):[],u=r.TAGS?r.TAGS.split(",").map((e=>{const t=e.trim();return{id:g.transform(f.transform(t,"-")).toLowerCase(),name:t}})):[],$={id:r.ID,name:r.NAME,purchasePrice:r.PURCHASE_PRICE?b(r.PURCHASE_PRICE):null,price:r.PRICE?b(r.PRICE):null,groupLength:l.length?l.length:null,tags:u.length?u.map((e=>e.id)):t.firestore.FieldValue.delete(),currency:r.CURRENCY,unit:r.UNIT,brand:r.BRAND},w=new s($,{id:"required|alpha_dash|max:16",name:"required|string",purchasePrice:"numeric",price:"required|numeric",groupLength:"required|max:5","group.*.id":"alpha_dash|max:16","tags.*":"alpha_dash|max:12",currency:"required|in:USD,EUR,RUB,UAH",unit:"required|in:м,шт"});if(w.fails()){let t=`In row <b>${e+1}</b> Product ID <b>${$.id}</b>\n`;for(const[e,a]of Object.entries(w.errors.all()))t+=`Column <b>${e}</b> => <b>${a}</b> \n`;throw new Error(t)}if(w.passes()){if(2e3===p.size)throw new Error("Limit <b>2000</b> goods!");if(p.has($.id))throw new Error(`Product ID <b>${$.id}</b> in row <b>${e+1}</b> is exist`);p.add($.id);const r=t.firestore().collection("objects").doc(a).collection("products").doc($.id);c.set(r,{name:$.name,purchasePrice:$.purchasePrice,price:$.price,currency:$.currency,unit:$.unit,orderNumber:p.size,catalog:l[l.length-1],catalogsNamePath:l.map((e=>e.name)).join("#"),tags:u.length?u.map((e=>e.id)):t.firestore.FieldValue.delete(),tagsNames:u.length?u:t.firestore.FieldValue.delete(),brand:$.brand?$.brand:t.firestore.FieldValue.delete(),updatedAt:i,objectName:o.name},{merge:!0});const s=[];for(const r of l){if(s.push(r.name),!d.has(r.id)){d.set(r.id,{parentId:r.parentId});const e=t.firestore().collection("objects").doc(a).collection("catalogs").doc(r.id);h.set(e,{name:r.name,parentId:r.parentId,orderNumber:d.size,updatedAt:i,tags:t.firestore.FieldValue.delete(),hierarchicalUrl:s.join(" > ")},{merge:!0}),++y===n&&(await h.commit(),h=t.firestore().batch(),y=0)}if(d.get(r.id).parentId!==r.parentId)throw new Error(`Goods <b>${$.name}</b> in row <b>${e+1}</b>,\n  Catalog <b>${r.name}</b> moved from  <b>${d.get(r.id).parentId}</b> to  <b>${r.parentId}</b>, `)}for(const e of u)m.has(l[l.length-1].id)?m.get(l[l.length-1].id).has(e.id)||m.get(l[l.length-1].id).set(e.id,e.name):(m.set(l[l.length-1].id,new Map),m.get(l[l.length-1].id).set(e.id,e.name))}}}await c.commit(),await e.sendMessage(94899148,`<b>${r+n-1} rows scaned from ${j}</b>`,{parse_mode:"html"}),I.resetLocalCache(!0)}y!==n&&await h.commit();let k=t.firestore().batch(),N=0;for(const e of m){const r=t.firestore().collection("objects").doc(a).collection("catalogs").doc(e[0]);k.set(r,{tags:Array.from(e[1],(([e,t])=>({id:e,name:t})))},{merge:!0}),++N===n&&(await k.commit(),k=t.firestore().batch(),N=0)}N!==n&&await k.commit();try{await w(e,a,i)}catch(t){await e.sendMessage(94899148,`<b>Delete products error ${t}</b>`,{parse_mode:"html"})}const x=new Date-c;await e.sendMessage(94899148,`<b>Data uploaded in ${Math.floor(x/1e3)}s\nGoods: ${p.size}\nCatalogs: ${d.size}</b>`,{parse_mode:"html"})}})),R.register("aoboX",(function(e,t){e.exports=JSON.parse('{"type":"service_account","project_id":"rzk-com-ua","private_key_id":"d1d3248b8410a5e2775a5a321cc24db185af48b1","private_key":"-----BEGIN PRIVATE KEY-----\\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDZG0JWc2v1rEVZ\\nTx8vkOQfVh/72kIb8cmYXbNdEs2wH3Eg1svaJiGaRzqzYb2SPTA7XA6sI0guEBi/\\n3khlgp/jjv6CWW4SWH8yB+6jjaZ8zldkUbnFXR4vle5P6RJDSpHTQWG2WbZlJ7vX\\n+zAfa6oy4PqPcYsFTPpK+y34i7m0asTI3NxyFg54IxKoRz78nbeCcJ+LSfDsASxg\\n5T3lz42KB2OCaJvxyfGmuxJt1PdmzBaltdCuxyM6U3AUUzl0R+DdiE2JTwexxR6S\\nOXzvkGPnkJWDD34r07BO4nzXJsQFybC96dESEEaWwtAG2pJF26UvpqJyHS7qfIWl\\nh9sTBmexAgMBAAECggEAQSehHPi+qZftqAPKxCejjpP2PUsfE+vYKFXWglQmTnjh\\nJo3P18QhyX8e6r6mecDLPMU/0gE0pD5IbyxyZaRx/4TmdJAKLI9KfOVMhOD52fLC\\n32R3b/emG3nPb0PvKyqx4Mh6XpNF3c2y3fqQUp2pEmPaTjoxEoIri10eSr0EGlRy\\n12eC/h937tzZDZ+YleKkluyoVFc9DrWeGRPVzNrLl3jkj36xxCjmxKIUh7pXf1/y\\n24BrU60YXWJcqa+bR8XgTWneJwrSYw+OBjhMFazvqSo2nmvDr5PxjY7yqtTwtQPg\\n2UAViQFDFsFBgXvezc/VYo75MZXqcLrh1BxR9+U90QKBgQD3XbP2DEeyJbGlI8BX\\nSecdsw3bUwVfTXviJw7mz5wXU3NXN3w87TIhCgntn/yRG3op+khVSgEsikQAkH17\\nnCReCWTWpvzofbghzsISgJbGC7tdW8yR8/CIGegHrLTZhENeW7uKU4FAq2DolzIQ\\nv2jwMDU4zoPF8v74QpNlka81lwKBgQDgry1YqE/r/TQmNaQi7Y5Sq39Osp/fEMRU\\nSpOpFDb/D4YYKIS/Mg/+QKGdDIudaG5f5R/RPxLCBLu93v72wjRg/wLguAgsCefM\\nohAkbvY3DneO/QGbUan5zFKZe8ZEIpqaRQM8KUEHldYbrEuRR10psdzTD9o6zapl\\n/Kw4A7hF9wKBgQCTBL8bwqquB9cwRjJf7s2NCkl3DD3KKbwyanJh3gxwlKmdsZ2G\\nfJdpqZTDBW5QNBuEbXumLUjLVxYZm8bou6GlvkGPjkoMSAQzG7ae1oxGAt0GHLRW\\nHrzbt0H/pbcK/KApqa2qBf1xGSqMsqgP6iONdal8LMmG0eiWVsNR/6c52wKBgQDN\\nAyqWReW/B+fIoZNmB2qgxjlAfr5flHYAD5hSY86WxvxtGLOfnbd4IFMW8PaHp11n\\nBLMWg73C6PzBkDMGx0dx5d4jW+ig/lzSnGGsTM8+h2XSQ8tuhIJbGvOXdpf/Xa/B\\n6gy8nUvn9vFJiNne8sXwIInE0CcpFrZPntEpv0MqGwKBgEzzKdFth0E6M3tkB9cv\\nOV3ZYLboq7TJhMHuvCjNsVzejaxQYNXY8QT2/KiA+DlmtHX8TvV8DAQV+HUf4OP+\\nMnSnjDWnts1/MekUYZv7ZoBHN7/fj7nu80BCakDqhD6I3t5RmKHULWMrZ2XcdQ5j\\nCvTcY47FRGJwvOBcGieVK8gc\\n-----END PRIVATE KEY-----\\n","client_email":"google-spreadsheet@rzk-com-ua.iam.gserviceaccount.com","client_id":"105320262335170153455","auth_uri":"https://accounts.google.com/o/oauth2/auth","token_uri":"https://oauth2.googleapis.com/token","auth_provider_x509_cert_url":"https://www.googleapis.com/oauth2/v1/certs","client_x509_cert_url":"https://www.googleapis.com/robot/v1/metadata/x509/google-spreadsheet%40rzk-com-ua.iam.gserviceaccount.com"}')})),R.register("3qHa4",(function(e,a){var r,o,s,c,i;j(e.exports,"store",(()=>r),(e=>r=e)),j(e.exports,"cart",(()=>o),(e=>o=e)),j(e.exports,"roundNumber",(()=>s),(e=>s=e)),j(e.exports,"photoCheckUrl",(()=>c),(e=>c=e)),j(e.exports,"savePhotoTelegram",(()=>i),(e=>i=e));const d=t.storage().bucket();var l=R("kfOvQ").download;const u=e=>Math.round(100*(e+Number.EPSILON))/100,p={async findRecord(e,t){const a=await this.getQuery(e).get();if(a.exists){if(t){const e=t.split(".");let r=a.data(),o=0;return e.forEach((e=>{r[e]&&(r=r[e],o++)})),o===e.length&&Object.keys(r).length?{...r}:null}return{id:a.id,...a.data()}}return null},async createRecord(e,t){await this.getQuery(e).set({...t},{merge:!0})},async updateRecord(e,t){await this.getQuery(e).update({...t})},async deleteRecord(e,a){await this.getQuery(e).set({[a]:t.firestore.FieldValue.delete()},{merge:!0})},async findAll(e){const a=await t.firestore().collection(e).get(),r=[];return a.docs.forEach((e=>{r.push({id:e.id,...e.data()})})),r},getQuery:e=>t.firestore().doc(e),payments(){const e=process.env.BOT_PAYMENT,t=new Map;if(e)for(const a of e.split("&"))t.set(+a.split("=")[0],a.split("=")[1].trim());return t},carriers(){const e=process.env.BOT_CARRIER,t=new Map;if(e)for(const a of e.split("&")){const e=a.split("=")[1].trim(),r=e.match(/^!(.*)/),o={};r?(o.name=r[1].trim(),o.reqNumber=!0):(o.name=e,o.reqNumber=!1),t.set(+a.split("=")[0],o)}return t},statuses(){const e=process.env.BOT_STATUS,t=new Map;if(e)for(const a of e.split("&"))t.set(+a.split("=")[0],a.split("=")[1].trim());return t},sort(e){const t=[];if(e){for(const[a,r]of Object.entries(e))t.push({id:a,...r});t.sort((function(e,t){return e.createdAt-t.createdAt}))}return t},formatOrderNumber:(e,t)=>`${e}-${("000"+t).slice(-4)}`},m={async add(e,a,r,o){let s={};(o=Number(o))?(s="object"==typeof r?{[r.id]:{name:`${r.brand?r.brand+" ":""}${r.name}`,price:r.price,unit:r.unit,qty:o,createdAt:Math.floor(Date.now()/1e3)}}:{[r]:{qty:o}},await p.createRecord(`objects/${e}/carts/${a}`,{updatedAt:Math.floor(Date.now()/1e3),products:s})):"object"!=typeof r&&await p.createRecord(`objects/${e}/carts/${a}`,{products:{[r]:t.firestore.FieldValue.delete()}})},async products(e,t){const a=await p.findRecord(`objects/${e}/carts/${t}`,"products");return p.sort(a)},async clear(e,t){await p.createRecord(`objects/${e}/carts/${t}`,{products:null})},async createOrder(e){const a=e.from.id;await p.createRecord(`users/${a}`,{orderCount:t.firestore.FieldValue.increment(1)});const r=await p.findRecord(`users/${a}`),o=r.session.objectId,s=t.firestore().collection("objects").doc(o).collection("orders"),c=await p.findRecord(`objects/${o}/carts/${a}`,"products"),i=await p.findRecord(`objects/${o}`);await s.add({userId:+r.id,objectId:o,objectName:i.name,orderNumber:r.orderCount,statusId:1,fromBot:!0,products:c,createdAt:Math.floor(Date.now()/1e3),...r.session.wizardData}),await this.clear(o,a)},async cartButtons(e,t){const a=await p.findRecord(`objects/${e}/carts/${t}`,"products");return[{text:"🏪 Главная",callback_data:`objects/${e}`},{text:`🛒 Корзина (${a&&Object.keys(a).length||0})`,callback_data:`cart?o=${e}`}]},async cartInfo(e,t){let a=0,r=0,o=0;if(t){const s=await this.products(e,t);for(const e of s)a++,r+=e.qty,o+=e.qty*e.price}return{cartCount:a,totalQty:r,totalSum:u(o)}}};r=p,o=m,s=u,c=async(e,t)=>{if(e){if((await d.file(e).exists())[0])return d.file(e).publicUrl();if(t)return!1}return process.env.BOT_LOGO},i=async(e,t,a)=>{if(e.message.media_group_id)throw new Error("Choose only one Photo!");const r=e.message.photo,o=[];if(r.length<3)throw new Error("Choose large photo!");o.push(r[1]),o.push(4==r.length?r[3]:r[2]);const s=o[0].file_unique_id;for(const[a,r]of o.entries()){const o=await e.telegram.getFileLink(r.file_id);try{const e=await l(o.href);await d.upload(e,{destination:`${t}/${s}/${a+1}.jpg`}),n.unlinkSync(e)}catch(e){throw new Error(`Error upload photos ${e.message}`)}}return s}})),R.register("kfOvQ",(function(e,t){var a;j(e.exports,"download",(()=>a),(e=>a=e));const r=n.promises.mkdir;a=async function(e){const t=await u({method:"GET",url:e,responseType:"stream"}),a=new URL(e),o=d.basename(a.pathname),s=d.join(l.tmpdir(),"/rzk",o),c=d.dirname(s);await r(c,{recursive:!0});const i=n.createWriteStream(s);return t.data.pipe(i),new Promise(((e,a)=>{t.data.on("end",(()=>{e(s)})),t.data.on("error",(e=>{a(e)}))}))}})),(0,p.initializeApp)();var v=a.Telegraf,O=a.session;const C=t.storage().bucket();var A=(Re=R("3qHa4")).store,E=Re.cart,P=Re.photoCheckUrl,B=Re.savePhotoTelegram;const T=[];T.push((async(e,t)=>{if("objects"!==e.state.routeName)return t();{const t=e.state.param;let a="<b>Выберите склад</b>";const r=[];let o=null;if(t){const s=await A.findRecord(`objects/${t}`);a=`<b>${s.name}\nКонтакты: ${s.phoneArray.join()}\nАдрес: ${s.address}\nОписание: ${s.description}</b>\n`;const c=await E.cartButtons(t,e.from.id);r.push([{text:"📁 Каталог",callback_data:`c?o=${s.id}`}]),r.push([c[1]]),e.state.isAdmin&&(r.push([{text:`🧾 Заказы ${s.name}`,callback_data:`orders?o=${s.id}`}]),r.push([{text:"Обновить данные",callback_data:`upload/${s.id}?todo=updateObject`}]),r.push([{text:"Загрузить товары",callback_data:`upload/${s.id}?todo=uploadProducts`}]),r.push([{text:"📸 Загрузить фото каталогов",callback_data:`c?o=${s.id}&u=1`}]),r.push([{text:"📸 Загрузить фото объекта",callback_data:`uploadPhotoObj/${s.id}`}]),a+=`<b>Курсы валют: USD = ${s.currencies.USD}${process.env.BOT_CURRENCY}, EUR = ${s.currencies.EUR}${process.env.BOT_CURRENCY}</b>\n`),r.push([{text:"🏠 Главная",callback_data:"objects"}]),s.photoId&&(o=`photos/o/${t}/logo/${s.photoId}/2.jpg`)}else{(await A.findAll("objects")).forEach((e=>{r.push([{text:`🏪 ${e.name}`,callback_data:`objects/${e.id}`}])})),r.push([{text:"🧾 Мои заказы",callback_data:`myO/${e.from.id}`}]),r.push([{text:"🧾 Поиск товаров",callback_data:"search"}]),r.push([{text:`Войти на сайт ${process.env.BOT_SITE}`,login_url:{url:`https://${process.env.BOT_SITE}/login`,request_write_access:!0}}])}const s=await P(o);await e.editMessageMedia({type:"photo",media:s,caption:a,parse_mode:"html"},{reply_markup:{inline_keyboard:r}}),await e.answerCbQuery()}})),T.push((async(e,t)=>{if("uploadPhotoObj"!==e.state.routeName)return t();{const t=e.state.param;await A.createRecord(`users/${e.from.id}`,{session:{scene:"uploadPhotoObj",objectId:t}});const a=await A.findRecord(`objects/${t}`);await e.replyWithHTML(`Добавьте фото <b>${a.name} (${a.id})</b>`),await e.answerCbQuery()}}));T.push((async(e,t)=>{if("search"!==e.state.routeName)return t();await A.createRecord(`users/${e.from.id}`,{session:{scene:"search"}}),await e.replyWithHTML("Введите поисковой запрос"),await e.answerCbQuery()}));var q=T,U=async e=>{const t=[];(await A.findAll("objects")).forEach((e=>{t.push([{text:`🏪 ${e.name}`,callback_data:`objects/${e.id}`}])})),t.push([{text:"🧾 Мои заказы",callback_data:`myO/${e.from.id}`}]),t.push([{text:"🧾 Поиск товаров",callback_data:"search"}]),t.push([{text:`Войти на сайт ${process.env.BOT_SITE}`,login_url:{url:`https://${process.env.BOT_SITE}/login`,request_write_access:!0}}]);const a=await P();await e.replyWithPhoto(a,{caption:"<b>Выберите склад</b>",parse_mode:"html",reply_markup:{inline_keyboard:t}})},M=(e,t)=>{if(e.callbackQuery&&"data"in e.callbackQuery){e.state.routeName=e.match[1],e.state.param=e.match[2];const t=e.match[3],a=new Map;if(t)for(const e of t.split("&"))a.set(e.split("=")[0],e.split("=")[1]);e.state.params=a}return t()},S=(e,t)=>(e.state.isAdmin=94899148===e.from.id,t()),D=async(e,t)=>{if(t){const a=await A.findRecord(`objects/${t}`);a.photoId&&await C.deleteFiles({prefix:`photos/o/${t}/logo`});try{const r=await B(e,`photos/o/${t}/logo`);await A.updateRecord(`objects/${t}`,{photoId:r});const o=`objects/${t}`,s=await P(`photos/o/${t}/logo/${r}/2.jpg`);await e.replyWithPhoto({url:s},{caption:`${a.name} (${a.id}) photo uploaded`,reply_markup:{inline_keyboard:[[{text:"⤴️ Goto object",callback_data:o}]]}}),await A.createRecord(`users/${e.from.id}`,{session:{scene:null,objectId:null}})}catch(t){return void await e.reply(`Error upload photos ${t.message}`)}}else await e.reply("Please select a object to upload Photo")};const z=[];z.push((async(e,a)=>{if("mono"!==e.state.routeName)return a();{const a=e.state.param,r=await async function(e){const a=await t.firestore().collection("currencies").get();let r={};const o={},s=Math.floor(Date.now()/1e3);a.forEach((e=>{s-e.data().updatedAt<3600?r[e.id]=e.data():o[e.id]=e.data()})),0===Object.keys(r).length&&(r=await async function(e){try{const e=await u.get("https://api.monobank.ua/bank/currency"),a=e.data.find((e=>e.currencyCodeA===Number(m.code("USD").number))),r=e.data.find((e=>e.currencyCodeA===Number(m.code("EUR").number))),o=e.data.find((e=>e.currencyCodeA===Number(m.code("RUB").number))),s=Math.floor(Date.now()/1e3);return await Promise.all([t.firestore().doc("currencies/USD").set({updatedAt:s,...a}),t.firestore().doc("currencies/EUR").set({updatedAt:s,...r}),t.firestore().doc("currencies/RUB").set({updatedAt:s,...o})]),{USD:a,EUR:r,RUB:o}}catch(e){return{}}}(),0===Object.keys(r).length&&(r=o));return r}(),o=Math.floor(Date.now()/1e3);await e.editMessageText(function(e){const t=m.number(e.currencyCodeA).code,a=$.unix(e.date);return`CURRENCY: *${t}*\nRATE BUY: *${e.rateBuy}*\nRATE SELL: *${e.rateSell}*\nUPDATED: ${a.fromNow()}`}(r[a]),{parse_mode:"Markdown",reply_markup:{inline_keyboard:[[{text:"🇱🇷 USD",callback_data:`mono/USD?${o}`},{text:"🇪🇺 EUR",callback_data:"mono/EUR"}],[{text:"Monobank.com.ua",url:"https://monobank.com.ua"}]]}}),await e.answerCbQuery()}}));var L,Q,G,H,F=async e=>{await e.reply("Выберите валюту",{reply_markup:{inline_keyboard:[[{text:"🇱🇷 USD",callback_data:"mono/USD"},{text:"🇪🇺 EUR",callback_data:"mono/EUR"}],[{text:"Monobank.com.ua",url:"https://monobank.com.ua"}]]}})},W=z,Y=R("hvq1b"),K=Y.uploadActions,X=Y.uploadForm;const V=t.storage().bucket();var Z=(Re=R("3qHa4")).cart,J=Re.store,ee=Re.roundNumber,te=Re.photoCheckUrl,ae=Re.savePhotoTelegram;const re=[],oe=async(e,a)=>{if("c"!==e.state.routeName)return a();{const a=e.state.params.get("o"),r=await Z.cartButtons(a,e.from.id),o=e.state.param,s=e.state.params.get("t"),c=e.state.params.get("s"),i=e.state.params.get("e"),n=e.state.params.get("u");let d=null;const l=await J.findRecord(`objects/${a}`);l.photoId&&(d=`photos/o/${a}/logo/${l.photoId}/2.jpg`);let u="";n&&(u+="&u=1");const p=[];if(e.session.pathCatalog=e.callbackQuery.data,o){const r=await J.findRecord(`objects/${a}/catalogs/${o}`);p.push([{text:`⤴️ ../${r.name}`,callback_data:r.parentId?`c/${r.parentId}?o=${a}${u}`:`c?o=${a}${u}`}]),e.state.isAdmin&&n&&p.push([{text:`📸 Загрузить фото каталога ${r.name}`,callback_data:`uploadPhotoCat/${r.id}?o=${a}`}]);let m=t.firestore().collection("objects").doc(a).collection("products").where("catalog.id","==",r.id).orderBy("orderNumber"),$="";if(s&&(m=m.where("tags","array-contains",s),$=`&t=${s}`),r.tags){const e=[];e.push({text:"📌 Фильтр",callback_data:`t/${r.id}?o=${a}`}),s&&(e[0].callback_data=`t/${r.id}?tagSelected=${s}&o=${a}`,e.push({text:`❎ ${s}`,callback_data:`c/${r.id}?o=${a}`})),p.push(e)}(await t.firestore().collection("objects").doc(a).collection("catalogs").where("parentId","==",o).orderBy("orderNumber").get()).docs.forEach((e=>{p.push([{text:`🗂 ${e.data().name}`,callback_data:`c/${e.id}?o=${a}${u}`}])}));let b=m;if(c){const e=await t.firestore().collection("objects").doc(a).collection("products").doc(c).get();b=b.startAfter(e)}if(i){const e=await t.firestore().collection("objects").doc(a).collection("products").doc(i).get();b=b.endBefore(e).limitToLast(10)}else b=b.limit(10);const h=await b.get(),f=await J.findRecord(`objects/${a}/carts/${e.from.id}`,"products");for(const e of h.docs){const t={text:`📦 ${ee(e.data().price*l.currencies[e.data().currency])}${process.env.BOT_CURRENCY} ${e.data().name} (${e.id})`,callback_data:`aC/${e.id}?o=${a}`},r=f&&f[e.id];r&&(t.text=`🛒${r.qty}${r.unit} ${ee(r.price*r.qty)} ${process.env.BOT_CURRENCY} ${e.data().name} (${e.id})`,t.callback_data=`aC/${e.id}?qty=${r.qty}&a=1&o=${a}`),p.push([t])}if(!h.empty){const e=[],t=h.docs[0];(await m.endBefore(t).limitToLast(1).get()).empty||e.push({text:"⬅️ Назад",callback_data:`c/${r.id}?e=${t.id}${$}&o=${a}`});const o=h.docs[h.docs.length-1];(await m.startAfter(o).limit(1).get()).empty||e.push({text:"➡️ Вперед",callback_data:`c/${r.id}?s=${o.id}${$}&o=${a}`}),p.push(e)}r.photoId&&(d=`photos/o/${a}/c/${r.id}/${r.photoId}/2.jpg`)}else{p.push([{text:"⤴️ ../Главная",callback_data:`objects/${a}`}]);(await t.firestore().collection("objects").doc(a).collection("catalogs").where("parentId","==",null).orderBy("orderNumber").get()).docs.forEach((e=>{p.push([{text:`🗂 ${e.data().name}`,callback_data:`c/${e.id}?o=${a}${u}`}])}))}r[0].text=`🏪 ${l.name}`,p.push(r);const m=await te(d);await e.editMessageMedia({type:"photo",media:m,caption:`<b>${l.name} > Каталог</b>\nhttps://${process.env.BOT_SITE}/o/${a}/c${o?"/"+o:""}`,parse_mode:"html"},{reply_markup:{inline_keyboard:p}}),await e.answerCbQuery()}};re.push(oe);re.push((async(e,t)=>{if("p"!==e.state.routeName)return t();{const t=e.state.param,a=e.state.params.get("o"),r=await J.findRecord(`objects/${a}`),o=await J.findRecord(`objects/${a}/products/${t}`);o.price=ee(o.price*r.currencies[o.currency]);const s=await Z.cartButtons(a,e.from.id);let c=`c/${o.catalog.id}?o=${a}`;e.session.pathCatalog&&(c=e.session.pathCatalog);const i=[];i.push([{text:`⤴️ ../${o.catalog.name}`,callback_data:c}]);const n={text:"🛒 Добавить в корзину",callback_data:`aC/${o.id}?o=${a}`},d=await J.findRecord(`objects/${a}/carts/${e.from.id}`,`products.${t}`);d&&(n.text=`🛒 ${d.qty} ${d.unit}  ${ee(d.qty*d.price)} ${process.env.BOT_CURRENCY}`,n.callback_data=`aC/${o.id}?qty=${d.qty}&a=1&o=${a}`),i.push([n]),e.state.isAdmin&&i.push([{text:"📸 Загрузить фото",callback_data:`uploadPhotoProduct/${o.id}?o=${a}`}]),o.photos&&o.photos.length&&i.push([{text:`🖼 Показать фото (${o.photos.length})`,callback_data:`showPhotos/${o.id}?o=${a}`}]);let l=null;r.photoId&&(l=`photos/o/${a}/logo/${r.photoId}/2.jpg`),o.mainPhoto&&(l=`photos/o/${a}/p/${o.id}/${o.mainPhoto}/2.jpg`),s[0].text=`🏪 ${r.name}`,i.push(s);const u=await te(l);await e.editMessageMedia({type:"photo",media:u,caption:`<b>${r.name}\n${o.name} (${o.id})\nЦена ${o.price} ${process.env.BOT_CURRENCY}</b>\nhttps://${process.env.BOT_SITE}/o/${a}/p/${t}`,parse_mode:"html"},{reply_markup:{inline_keyboard:i}}),await e.answerCbQuery()}})),re.push((async(e,t)=>{if("aC"!==e.state.routeName)return t();{let a=e.state.params.get("qty");const r=e.state.params.get("number"),o=e.state.params.get("back"),s=e.state.params.get("r"),c=e.state.params.get("a"),i=e.state.param,n=e.state.params.get("addVal"),d=e.state.params.get("o");let l="",u="";if(a)r&&(a+=r),o&&(a=a.slice(0,-1));else if(Number(r))a=r;else{u+=`&${Math.floor(Date.now()/1e3)}`}a?l=`&qty=${a}`:a=0,s&&(u+="&r=1",e.session.pathCatalog=null),c&&(u+="&a=1");const p=await J.findRecord(`objects/${d}`),m=await J.findRecord(`objects/${d}/products/${i}`);if(m.price=ee(m.price*p.currencies[m.currency]),m){let r=`c/${m.catalog.id}?o=${d}`;if(e.session.pathCatalog&&(r=e.session.pathCatalog),n){if(await Z.add(d,e.from.id,c?m.id:m,n),s)e.state.routeName="cart",await se(e,t);else{e.state.routeName="c";const a=r.match(/^([a-zA-Z0-9-_]+)\/?([a-zA-Z0-9-_]+)?\??([a-zA-Z0-9-_=&\/:~+]+)?/);e.state.param=a[2];const o=a[3];if(e.state.params.clear(),o)for(const t of o.split("&"))e.state.params.set(t.split("=")[0],t.split("=")[1]);e.callbackQuery.data=r,await oe(e,t)}return}const o=[],$={text:"🛒 Добавить",callback_data:`aC/${m.id}?addVal=${a}${u}&o=${d}`},b={text:"❎ Удалить",callback_data:`aC/${m.id}?addVal=0${u}&o=${d}`};c&&o.push(b),o.push($);let h=null;p.photoId&&(h=`photos/o/${d}/logo/${p.photoId}/2.jpg`),m.mainPhoto&&(h=`photos/o/${d}/p/${m.id}/${m.mainPhoto}/2.jpg`);const f=[];e.state.isAdmin&&(f.push({text:"📸 Загрузить фото",callback_data:`uploadPhotoProduct/${m.id}?o=${d}`}),f.push({text:"Загрузить в Merch",callback_data:`uploadMerch/${m.id}?o=${d}`}));const g=await te(h);await e.editMessageMedia({type:"photo",media:g,caption:`${m.name} (${m.id})\nЦена ${m.price} ${process.env.BOT_CURRENCY}\nСумма ${ee(a*m.price)} ${process.env.BOT_CURRENCY}\n<b>Количетво: ${a} ${m.unit}</b>\nhttps://${process.env.BOT_SITE}/o/${d}/p/${i}`,parse_mode:"html"},{reply_markup:{inline_keyboard:[[{text:`⤴️ ../${m.catalog.name}`,callback_data:r}],[{text:"7",callback_data:`aC/${m.id}?number=7${l}${u}&o=${d}`},{text:"8",callback_data:`aC/${m.id}?number=8${l}${u}&o=${d}`},{text:"9",callback_data:`aC/${m.id}?number=9${l}${u}&o=${d}`}],[{text:"4",callback_data:`aC/${m.id}?number=4${l}${u}&o=${d}`},{text:"5",callback_data:`aC/${m.id}?number=5${l}${u}&o=${d}`},{text:"6",callback_data:`aC/${m.id}?number=6${l}${u}&o=${d}`}],[{text:"1",callback_data:`aC/${m.id}?number=1${l}${u}&o=${d}`},{text:"2",callback_data:`aC/${m.id}?number=2${l}${u}&o=${d}`},{text:"3",callback_data:`aC/${m.id}?number=3${l}${u}&o=${d}`}],[{text:"0️",callback_data:`aC/${m.id}?number=0${l}${u}&o=${d}`},{text:"🔙",callback_data:`aC/${m.id}?back=1${l}${u}&o=${d}`},{text:"AC",callback_data:`aC/${m.id}?clear=1${u}&o=${d}`}],o,f,[{text:`⤴️ ${m.name} (${m.id})`,callback_data:`p/${m.id}?o=${d}`}]]}})}await e.answerCbQuery()}}));const se=async(e,t)=>{if("cart"!==e.state.routeName)return t();{const t=e.state.params.get("clear"),a=e.state.params.get("deleteOrderId"),r=e.state.params.get("o");a&&await J.createRecord(`users/${e.from.id}`,{session:{orderData:null}}),t&&await Z.clear(r,e.from.id);const o=[],s=await J.findRecord(`objects/${r}`);let c=`<b>${s.name} > Корзина</b>\n`,i=0,n=0,d=0;const l=await Z.products(r,e.from.id);for(const[t,a]of l.entries()){const l=await J.findRecord(`objects/${r}/products/${a.id}`);if(l.price=ee(l.price*s.currencies[l.currency]),l){const s=`${t+1}) <b>${l.name}</b> (${l.id})=${l.price} ${process.env.BOT_CURRENCY}*${a.qty}${l.unit}=${ee(l.price*a.qty)}${process.env.BOT_CURRENCY}`;if((c+`${s}\n`).length<1e3&&(c+=`${s}\n`,d++),o.push([{text:`${t+1}) ${a.qty}${l.unit}=${ee(a.qty*l.price)} ${process.env.BOT_CURRENCY} ${l.name} (${l.id})`,callback_data:`aC/${l.id}?qty=${a.qty}&r=1&a=1&o=${r}`}]),l.price!==a.price){const t={[l.id]:{price:l.price}};await J.createRecord(`objects/${r}/carts/${e.from.id}`,{products:t})}i+=a.qty,n+=a.qty*l.price}}if(d!==o.length&&(c+="⬇️Весь список нажмите на ссылку корзины⬇️\n"),i&&(c+=`<b>Количество товара: ${i}\nСумма: ${ee(n)} ${process.env.BOT_CURRENCY}</b>`),o.length<1)o.push([{text:"📁 Каталог",callback_data:`c?o=${r}`}]),c+="Корзина пуста";else{const t=await J.findRecord(`users/${e.from.id}`,"session.orderData");if(t){const e=t.orderNumber;o.push([{text:`✅ Сохранить Заказ #${e} от ${t.lastName} ${t.firstName}`,callback_data:`eO/${t.id}?sP=1&o=${r}`}]),o.push([{text:`❎ Убрать Заказ #${e} от ${t.lastName} ${t.firstName}`,callback_data:`cart?deleteOrderId=${t.id}&o=${r}`}])}o.push([{text:"✅ Оформить заказ",callback_data:`cO/payment?o=${r}`}]),o.push([{text:"🗑 Очистить корзину",callback_data:`cart?clear=1&o=${r}`}]),o.push([{text:"Ссылка на корзину",url:`https://${process.env.BOT_SITE}/o/${r}/share-cart/${e.from.id}`}])}o.push([{text:`🏪 ${s.name}`,callback_data:`objects/${r}`}]);let u=null;s.photoId&&(u=`photos/o/${r}/logo/${s.photoId}/2.jpg`);const p=await te(u);await e.editMessageMedia({type:"photo",media:p,caption:c,parse_mode:"html"},{reply_markup:{inline_keyboard:o}}),await e.answerCbQuery()}};re.push(se);const ce=[async(e,t,a=[])=>{await e.editMessageCaption(`<b>${t}:</b>`,{parse_mode:"html",reply_markup:{inline_keyboard:a}})},async(e,t)=>{const a=[];let r=e.state.params.get("q");const o=e.state.params.get("n"),s=e.state.params.get("b"),c=e.state.params.get("cId"),i=e.state.params.get("oId"),n=e.state.params.get("o");let d="";r?(o&&(r+=o),s&&(r=r.slice(0,-1))):Number(o)&&(r=o),r?d=`&q=${r}`:r=0,c&&(d+=`&cId=${c}`);let l="";i&&(l=`&oId=${i}&o=${n}`);let u="";!t&&Number(o)||(u=Math.random().toFixed(2).substring(2)),a.push([{text:"7",callback_data:`cO/cN?n=7${d}${l}`},{text:"8",callback_data:`cO/cN?n=8${d}${l}`},{text:"9",callback_data:`cO/cN?n=9${d}${l}`}]),a.push([{text:"4",callback_data:`cO/cN?n=4${d}${l}`},{text:"5",callback_data:`cO/cN?n=5${d}${l}`},{text:"6",callback_data:`cO/cN?n=6${d}${l}`}]),a.push([{text:"1",callback_data:`cO/cN?n=1${d}${l}`},{text:"2",callback_data:`cO/cN?n=2${d}${l}`},{text:"3",callback_data:`cO/cN?n=3${d}${l}`}]),a.push([{text:"0️",callback_data:`cO/cN?n=0${d}${l}`},{text:"🔙",callback_data:`cO/cN?b=1${d}${l}`},{text:"AC",callback_data:`cO/cN?cId=${c}${l}`}]),i?(a.push([{text:"Выбрать отделение",callback_data:`eO/${i}?sCid=${c}&n=${r}&o=${n}&${u}`}]),a.push([{text:"⬅️ Назад",callback_data:`orders/${i}?o=${n}`}])):a.push([{text:"Выбрать отделение",callback_data:`cO/wizard?cN=${r}&cId=${c}&${u}`}]),await e.editMessageCaption(`Введите номер отделения:\n<b>${r}</b>\n`+(t?"Ошибка: введите номер отделения":""),{parse_mode:"html",reply_markup:{inline_keyboard:a}})},async e=>{await e.reply("Укажите адрес доставки (город)",{reply_markup:{keyboard:[["Отмена"]],resize_keyboard:!0}}),await J.createRecord(`users/${e.from.id}`,{session:{scene:"wizardOrder",cursor:3}})},async e=>{if(e.message.text.length<2)return void await e.reply("Адрес слишком короткий");const t=e.message.text;await J.createRecord(`users/${e.from.id}`,{session:{wizardData:{address:t}}});const a=e.from.last_name?e.from.last_name:null,r=a?[[a],["Отмена"]]:[["Отмена"]];await e.reply("Введите фамилию получателя "+(a?"или выберите свою":""),{reply_markup:{keyboard:r,resize_keyboard:!0}}),await J.createRecord(`users/${e.from.id}`,{session:{cursor:4}})},async e=>{if(e.message.text.length<2)return void await e.reply("Фамилия слишком короткая");const t=e.message.text;await J.createRecord(`users/${e.from.id}`,{session:{wizardData:{lastName:t}}});const a=[[e.from.first_name],["Отмена"]];await e.reply("Введите имя получателя или выберите свое",{reply_markup:{keyboard:a,resize_keyboard:!0}}),await J.createRecord(`users/${e.from.id}`,{session:{cursor:5}})},async e=>{if(e.message.text.length<2)return void await e.reply("Имя слишком короткое");const t=e.message.text;await J.createRecord(`users/${e.from.id}`,{session:{wizardData:{firstName:t}}}),await e.reply("Введите номер телефона",{reply_markup:{keyboard:[[{text:"Отправить свой номер",request_contact:!0}],["Отмена"]],resize_keyboard:!0}}),await J.createRecord(`users/${e.from.id}`,{session:{cursor:6}})},async e=>{const t=e.message.contact&&e.message.contact.phone_number||e.message.text,a=new RegExp(process.env.BOT_PHONEREGEXP),r=t.match(a);if(!r)return void await e.reply(`Введите номер телефона в формате ${process.env.BOT_PHONETEMPLATE}`);const o=`${process.env.BOT_PHONECODE}${r[2]}`;await J.createRecord(`users/${e.from.id}`,{session:{wizardData:{phoneNumber:o}}}),await e.replyWithHTML("Комментарий к заказу:",{reply_markup:{keyboard:[["Без комментариев"],["Отмена"]],resize_keyboard:!0}}),await J.createRecord(`users/${e.from.id}`,{session:{cursor:7}})},async e=>{if(e.message.text&&"Без комментариев"!==e.message.text){const t=e.message.text;await J.createRecord(`users/${e.from.id}`,{session:{wizardData:{comment:t}}})}const t=await J.findRecord(`users/${e.from.id}`,"session.wizardData");await e.replyWithHTML(`<b>Проверьте даные получателя:\n${t.lastName} ${t.firstName} ${t.phoneNumber}\nАдрес доставки: ${t.address}, ${J.carriers().get(t.carrierId).name} `+(t.carrierNumber?"#"+t.carrierNumber:"")+"\n"+`Оплата: ${J.payments().get(t.paymentId)}\n`+(t.comment?"Комментарий: "+t.comment:"")+"</b>",{reply_markup:{keyboard:[["Оформить заказ"],["Отмена"]],resize_keyboard:!0}}),await J.createRecord(`users/${e.from.id}`,{session:{cursor:8}})},async(e,t)=>{"Оформить заказ"===e.message.text&&(await Z.createOrder(e),await e.reply("Спасибо за заказ! Скоро мы с Вами свяжемся. /objects",{reply_markup:{remove_keyboard:!0}}),await J.createRecord(`users/${e.from.id}`,{session:{scene:null}}))}];re.push((async(e,t)=>{if("cO"!==e.state.routeName)return t();{const t=e.state.param;if("carrier"===t){const t=+e.state.params.get("payment_id"),a=e.state.params.get("o");await J.updateRecord(`users/${e.from.id}`,{"session.wizardData":{paymentId:t}});const r=[];J.carriers().forEach(((e,t)=>{e.reqNumber?r.push([{text:e.name,callback_data:`cO/cN?cId=${t}`}]):r.push([{text:e.name,callback_data:`cO/wizard?cId=${t}`}])})),r.push([{text:"🛒 Корзина",callback_data:`cart?o=${a}`}]),await ce[0](e,"Способ доставки",r)}if("cN"===t&&await ce[1](e),"payment"===t){const t=e.state.params.get("o");await J.createRecord(`users/${e.from.id}`,{session:{objectId:t}});const a=[];J.payments().forEach(((e,r)=>{a.push([{text:e,callback_data:`cO/carrier?payment_id=${r}&o=${t}`}])})),a.push([{text:"🛒 Корзина",callback_data:`cart?o=${t}`}]),await ce[0](e,"Способ оплаты",a)}if("wizard"===t){const t=+e.state.params.get("cId");await J.createRecord(`users/${e.from.id}`,{session:{wizardData:{carrierId:t}}});const a=+e.state.params.get("cN");if(2===t&&!a)return void await ce[1](e,"errorCurrierNumber");a&&await J.createRecord(`users/${e.from.id}`,{session:{wizardData:{carrierNumber:a}}}),await e.deleteMessage(),ce[2](e)}await e.answerCbQuery()}})),re.push((async(e,t)=>{if("t"!==e.state.routeName)return t();{const t=[],a=e.state.param,r=e.state.params.get("o"),o=await J.findRecord(`objects/${r}/catalogs/${a}`);let s=`c/${o.id}?o=${r}`;e.session.pathCatalog&&(s=e.session.pathCatalog),t.push([{text:`⤴️ ../${o.name}`,callback_data:s}]);for(const a of o.tags)a.id===e.state.params.get("tagSelected")?t.push([{text:`✅ ${a.name}`,callback_data:`c/${o.id}?t=${a.id}&o=${r}`}]):t.push([{text:`📌 ${a.name}`,callback_data:`c/${o.id}?t=${a.id}&o=${r}`}]);const c=await J.findRecord(`objects/${r}`);let i=null;c.photoId&&(i=`photos/o/${r}/logo/${c.photoId}/2.jpg`);const n=await te(i);await e.editMessageMedia({type:"photo",media:n,caption:`<b>${c.name} > Фильтр</b>`,parse_mode:"html"},{reply_markup:{inline_keyboard:t}}),await e.answerCbQuery()}})),re.push((async(e,a)=>{if("showPhotos"!==e.state.routeName)return a();{const a=e.state.param,r=e.state.params.get("o"),o=t.firestore().collection("objects").doc(r).collection("products").doc(a),s=await o.get(),c={id:s.id,...s.data()};for(const[t,a]of c.photos.entries()){const o=[];e.state.isAdmin&&(o.push([{text:"🏷 Set main",callback_data:`sMPh/${c.id}?pId=${a}&o=${r}`}]),o.push([{text:"🗑 Delete",callback_data:`dPh/${c.id}?pId=${a}&o=${r}`}])),o.push([{text:"❎ Закрыть",callback_data:"closePhoto"}]);let s=`<b>Фото #${t+1}</b> ${c.name} (${c.id})`;c.mainPhoto===a&&(s="✅ "+s);const i=await te(`photos/o/${r}/p/${c.id}/${a}/2.jpg`);await e.replyWithPhoto(i,{caption:s,parse_mode:"html",reply_markup:{inline_keyboard:o}})}await e.answerCbQuery()}})),re.push((async(e,t)=>{if("sMPh"!==e.state.routeName)return t();{const t=e.state.param,a=e.state.params.get("pId"),r=e.state.params.get("o");await J.updateRecord(`objects/${r}/products/${t}`,{mainPhoto:a}),await e.editMessageCaption(`Main photo updated ${t}`,{reply_markup:{inline_keyboard:[[{text:"🗑 Delete",callback_data:`dPh/${t}?pId=${a}&o=${r}`}],[{text:"❎ Close",callback_data:"closePhoto"}]]}}),await e.answerCbQuery()}})),re.push((async(e,t)=>{if("closePhoto"!==e.state.routeName)return t();await e.deleteMessage(),await e.answerCbQuery()})),re.push((async(e,a)=>{if("dPh"!==e.state.routeName)return a();{const a=e.state.param,r=e.state.params.get("pId"),o=e.state.params.get("o"),s=t.firestore().collection("objects").doc(o).collection("products").doc(a),c=await s.get();if(c.data().mainPhoto===r)if(c.data().photos&&c.data().photos.length>1){for(const e of c.data().photos)if(e!==r){await s.update({mainPhoto:e,photos:t.firestore.FieldValue.arrayRemove(r)});break}}else await s.update({mainPhoto:t.firestore.FieldValue.delete(),photos:t.firestore.FieldValue.arrayRemove(r)});else await s.update({photos:t.firestore.FieldValue.arrayRemove(r)});await V.deleteFiles({prefix:`photos/o/${o}/p/${a}/${r}`}),await e.deleteMessage(),await e.answerCbQuery()}})),re.push((async(e,t)=>{if("uploadPhotoProduct"!==e.state.routeName)return t();{const t=e.state.params.get("o"),a=e.state.param;await J.createRecord(`users/${e.from.id}`,{session:{scene:"uploadPhotoProduct",objectId:t,productId:a}});const r=await J.findRecord(`objects/${t}/products/${a}`);await e.replyWithHTML(`Добавьте фото <b>${r.name} (${r.id})</b>`),await e.answerCbQuery()}})),re.push((async(e,t)=>{if("uploadPhotoCat"!==e.state.routeName)return t();{const t=e.state.params.get("o"),a=e.state.param;await J.createRecord(`users/${e.from.id}`,{session:{scene:"uploadPhotoCat",objectId:t,catalogId:a}});const r=await J.findRecord(`objects/${t}/catalogs/${a}`);await e.replyWithHTML(`Добавьте фото <b>${r.name} (${r.id})</b>`),await e.answerCbQuery()}}));L=async(e,a,r)=>{if(r&&a){const o=await J.findRecord(`objects/${a}/products/${r}`);if(o.photos&&o.photos.length>4)return void await e.reply("Limit 5 photos");try{const s=await ae(e,`photos/o/${a}/p/${o.id}`);o.mainPhoto?await J.updateRecord(`objects/${a}/products/${r}`,{photos:t.firestore.FieldValue.arrayUnion(s)}):await J.updateRecord(`objects/${a}/products/${r}`,{mainPhoto:s,photos:t.firestore.FieldValue.arrayUnion(s)});let c=`c/${o.catalog.id}?o=${a}&u=1`;e.session.pathCatalog&&(c=e.session.pathCatalog);const i=await te(`photos/o/${a}/p/${o.id}/${s}/2.jpg`);await e.replyWithPhoto(i,{caption:`${o.name} (${o.id}) photo uploaded`,reply_markup:{inline_keyboard:[[{text:"📸 Upload photo",callback_data:`uploadPhotoProduct/${o.id}?o=${a}`}],[{text:`🖼 Show photos (${o.photos?o.photos.length+1:1})`,callback_data:`showPhotos/${o.id}?o=${a}`}],[{text:"⤴️ Goto catalog",callback_data:c}]]}}),await J.createRecord(`users/${e.from.id}`,{session:{scene:null,objectId:null,productId:null}})}catch(t){return void await e.reply(`Error upload photos ${t.message}`)}}else await e.reply("Please select a product to upload Photo")},Q=async(e,t,a)=>{if(a&&t){const r=await J.findRecord(`objects/${t}/catalogs/${a}`);r.photoId&&await V.deleteFiles({prefix:`photos/o/${t}/c/${a}`});try{const a=await ae(e,`photos/o/${t}/c/${r.id}`);await J.updateRecord(`objects/${t}/catalogs/${r.id}`,{photoId:a});const o=`c/${r.id}?o=${t}`,s=await te(`photos/o/${t}/c/${r.id}/${a}/2.jpg`);await e.replyWithPhoto(s,{caption:`${r.name} (${r.id}) photo uploaded`,reply_markup:{inline_keyboard:[[{text:"⤴️ Goto catalog",callback_data:o}]]}}),await J.createRecord(`users/${e.from.id}`,{session:{scene:null,objectId:null,catalogId:null}})}catch(t){return void await e.reply(`Error upload photos ${t.message}`)}}else await e.reply("Please select a product to upload Photo")},G=re;var ie=se,ne=H=ce,de=(Re=R("3qHa4")).store,le=Re.cart,ue=Re.roundNumber,pe=Re.photoCheckUrl;const me=[],$e=async(e,a)=>{if("orders"!==e.state.routeName)return a();{const a=e.state.params.get("s"),r=e.state.params.get("e"),o=e.state.params.get("o"),s=[],c=e.state.param,i=10,n=await de.findRecord(`objects/${o}`);let d=`<b>Заказы ${n.name}</b>`;if(c){const t=await de.findRecord(`objects/${o}/orders/${c}`);if(t){e.session.pathOrderCurrent=e.callbackQuery.data;const a=$.unix(t.createdAt).locale("ru");d=`<b>${t.objectName} > Заказ #${de.formatOrderNumber(t.userId,t.orderNumber)} (${a.fromNow()})\n${t.lastName} ${t.firstName} ${t.phoneNumber}\nАдрес доставки: ${t.address}, ${de.carriers().get(t.carrierId).name} `+(t.carrierNumber?"#"+t.carrierNumber:"")+"\n"+`Оплата: ${de.payments().get(t.paymentId)}\n`+(t.comment?"Комментарий: "+t.comment+"\n":"")+"</b>";let r=0,o=0,s=0;const c=de.sort(t.products);c.forEach(((e,t)=>{const a=`${t+1})<b>${e.name}</b> (${e.id})=${e.price}${process.env.BOT_CURRENCY}*${e.qty}${e.unit}=${ue(e.price*e.qty)}${process.env.BOT_CURRENCY}`;(d+`${a}\n`).length<950&&(d+=`${a}\n`,s++),r+=e.qty,o+=e.qty*e.price})),s!==c.length&&(d+="⬇️Весь список нажмите на ссылку ⬇️\n"),d+=`<b>Количество товара: ${r}\nСумма: ${ue(o)} ${process.env.BOT_CURRENCY}</b>`}s.push([{text:"Ссылка на заказ",url:`https://${process.env.BOT_SITE}/o/${o}/s/${t.id}`}]),s.push([{text:`📝 Статус: ${de.statuses().get(t.statusId)}`,callback_data:`eO/${t.id}?sSI=${t.statusId}&o=${o}`}]),s.push([{text:`📝 Фамилия получателя: ${t.lastName}`,callback_data:`eO/${t.id}?e=lastName&o=${o}`}]),s.push([{text:`📝 Имя получателя: ${t.firstName}`,callback_data:`eO/${t.id}?e=firstName&o=${o}`}]),s.push([{text:`📝 Номер тел.: ${t.phoneNumber}`,callback_data:`eO/${t.id}?e=phoneNumber&o=${o}`}]),s.push([{text:`📝 Оплата: ${de.payments().get(t.paymentId)}`,callback_data:`eO/${t.id}?showPay=${t.paymentId}&o=${o}`}]),t.carrierNumber?s.push([{text:`📝 Доставка: ${de.carriers().get(t.carrierId).name} #${t.carrierNumber}`,callback_data:`eO/${t.id}?cId=${t.carrierId}&n=${t.carrierNumber}&o=${o}`}]):s.push([{text:`📝 Доставка: ${de.carriers().get(t.carrierId).name}`,callback_data:`eO/${t.id}?cId=${t.carrierId}&o=${o}`}]),s.push([{text:`📝 Адрес: ${t.address}`,callback_data:`eO/${t.id}?e=address&o=${o}`}]),s.push([{text:`📝 Комментарий: ${t.comment?t.comment:""}`,callback_data:`eO/${t.id}?e=comment&o=${o}`}]),s.push([{text:"📝 Редактировать товары",callback_data:`eO/${c}?eP=1&o=${o}`}]),s.push([{text:"📝 Информация о покупателе",callback_data:`eO?userId=${t.userId}&o=${t.objectId}`}]);const a=Math.random().toFixed(2).substring(2);s.push([{text:"🔄 Обновить",callback_data:`orders/${t.id}?o=${o}&${a}`}]),s.push([{text:"🧾 Заказы",callback_data:`${e.session.pathOrder?e.session.pathOrder:"orders?o="+t.objectId}`}])}else{e.session.pathOrderCurrent=null,e.session.pathOrder=e.callbackQuery.data;let c=t.firestore().collection("objects").doc(o).collection("orders").orderBy("createdAt","desc");const n=+e.state.params.get("statusId");let d="";n&&(c=c.where("statusId","==",n),d=`&statusId=${n}`);let l=c;if(a){const e=await de.getQuery(`objects/${o}/orders/${a}`).get();l=l.startAfter(e)}if(r){const e=await de.getQuery(`objects/${o}/orders/${r}`).get();l=l.endBefore(e).limitToLast(i)}else l=l.limit(i);const u=await l.get(),p=[];if(p.push({text:"📌 Статус заказа",callback_data:`eO/showStatuses?o=${o}`}),n&&(p[0].callback_data=`eO/showStatuses?selectedStatus=${n}&o=${o}`,p.push({text:`❎ ${de.statuses().get(n)}`,callback_data:`orders?o=${o}`})),s.push(p),u.docs.forEach((e=>{const t={id:e.id,...e.data()},a=$.unix(t.createdAt).locale("ru");s.push([{text:`🧾 Заказ #${de.formatOrderNumber(t.userId,t.orderNumber)},${de.statuses().get(t.statusId)}, ${a.fromNow()}`,callback_data:`orders/${t.id}?o=${o}`}])})),u.empty)s.push([{text:"Заказов нет",callback_data:`objects/${o}`}]);else{const e=[],t=u.docs[0];(await c.endBefore(t).limitToLast(1).get()).empty||e.push({text:"⬅️ Назад",callback_data:`orders?e=${t.id}${d}&o=${t.data().objectId}`});const a=u.docs[u.docs.length-1];(await c.startAfter(a).limit(1).get()).empty||e.push({text:"➡️ Вперед",callback_data:`orders?s=${a.id}${d}&o=${a.data().objectId}`}),s.push(e)}s.push([{text:"🏠 Главная",callback_data:"objects"}])}let l=null;n.photoId&&(l=`photos/o/${o}/logo/${n.photoId}/2.jpg`);const u=await pe(l);await e.editMessageMedia({type:"photo",media:u,caption:d,parse_mode:"html"},{reply_markup:{inline_keyboard:s}}),await e.answerCbQuery()}};me.push($e),me.push((async(e,a)=>{if("myO"!==e.state.routeName)return a();{const a=e.state.params.get("s"),r=e.state.params.get("e"),o=+e.state.param,s=[],c=e.state.params.get("oId"),i=e.state.params.get("o");let n="<b>Мои заказы</b>";e.session.pathOrderCurrent&&(n=`Заказы от ${o}`);const d=10;if(c){const t=await de.findRecord(`objects/${i}/orders/${c}`);if(t){const e=$.unix(t.createdAt).locale("ru");n+=`<b> > Заказ #${de.formatOrderNumber(t.userId,t.orderNumber)} (${e.fromNow()})\nСклад: ${t.objectName}\nСтатус: ${de.statuses().get(t.statusId)}\n${t.lastName} ${t.firstName} ${t.phoneNumber}\nАдрес доставки: ${t.address}, ${de.carriers().get(t.carrierId).name} `+(t.carrierNumber?"#"+t.carrierNumber:"")+"\n"+`Оплата: ${de.payments().get(t.paymentId)}\n`+(t.comment?"Комментарий: "+t.comment+"\n":"")+"</b>";let a=0,r=0,o=0;const s=de.sort(t.products);s.forEach(((e,t)=>{const s=`${t+1})<b>${e.name}</b> (${e.id})=${e.price} ${process.env.BOT_CURRENCY}*${e.qty}${e.unit}=${ue(e.price*e.qty)}${process.env.BOT_CURRENCY}`;(n+`${s}\n`).length<1e3&&(n+=`${s}\n`,o++),a+=e.qty,r+=e.qty*e.price})),o!==s.length&&(n+="⬇️Весь список нажмите на ссылку ⬇️\n"),n+=`<b>Количество товара: ${a}\nСумма: ${ue(r)} ${process.env.BOT_CURRENCY}</b>`}s.push([{text:"Ссылка на заказ",url:`https://${process.env.BOT_SITE}/o/${i}/s/${t.id}`}]),s.push([{text:"🧾 Мои заказы",callback_data:`${e.session.myPathOrder?e.session.myPathOrder:"myO/"+o}`}])}else{e.session.myPathOrder=e.callbackQuery.data;const c=t.firestore().collectionGroup("orders").where("userId","==",o).orderBy("createdAt","desc");let n=c;if(a){const e=await de.getQuery(`objects/${i}/orders/${a}`).get();n=n.startAfter(e)}if(r){const e=await de.getQuery(`objects/${i}/orders/${r}`).get();n=n.endBefore(e).limitToLast(d)}else n=n.limit(d);const l=await n.get();if(l.docs.forEach((e=>{const t={id:e.id,...e.data()},a=$.unix(t.createdAt).locale("ru");s.push([{text:`🧾 Заказ #${de.formatOrderNumber(t.userId,t.orderNumber)},${de.statuses().get(t.statusId)}, ${a.fromNow()}`,callback_data:`myO/${o}?oId=${t.id}&o=${t.objectId}`}])})),l.empty)s.push([{text:"У Вас пока нет заказов",callback_data:"objects"}]);else{const e=[],t=l.docs[0];(await c.endBefore(t).limitToLast(1).get()).empty||e.push({text:"⬅️ Назад",callback_data:`myO/${o}?e=${t.id}&o=${t.data().objectId}`});const a=l.docs[l.docs.length-1];(await c.startAfter(a).limit(1).get()).empty||e.push({text:"➡️ Вперед",callback_data:`myO/${o}?s=${a.id}&o=${a.data().objectId}`}),s.push(e)}e.session.pathOrderCurrent&&s.push([{text:"🏠 Вернуться к заказу",callback_data:`${e.session.pathOrderCurrent}`}]),s.push([{text:"🏠 Главная",callback_data:"objects"}])}const l=await pe();await e.editMessageMedia({type:"photo",media:l,caption:n,parse_mode:"html"},{reply_markup:{inline_keyboard:s}}),await e.answerCbQuery()}}));const be=[async e=>{await e.replyWithHTML(`Текущее значение ${e.session.fieldName}: <b>${e.session.fieldValue}</b>`,{reply_markup:{keyboard:[["Отмена"]],resize_keyboard:!0}}),e.session.scene="editOrder",e.session.cursor=1},async e=>{if("lastName"===e.session.fieldName&&e.message.text.length<2)await e.reply("Имя слишком короткое");else{if("phoneNumber"===e.session.fieldName){const t=new RegExp(process.env.BOT_PHONEREGEXP),a=e.message.text.match(t);if(!a)return void await e.reply(`Введите номер телефона в формате ${process.env.BOT_PHONETEMPLATE}`);e.message.text=`${process.env.BOT_PHONECODE}${a[2]}`}await de.updateRecord(`objects/${e.session.objectId}/orders/${e.session.orderId}`,{[e.session.fieldName]:e.message.text}),await e.reply("Данные сохранены. Обновите заказ!🔄",{reply_markup:{remove_keyboard:!0}}),e.session.scene=null}}];me.push((async(e,t)=>{if("eO"!==e.state.routeName)return t();{const a=e.state.param,r=e.state.params.get("e"),o=+e.state.params.get("cId"),s=+e.state.params.get("n"),c=+e.state.params.get("sCid"),i=+e.state.params.get("showPay"),n=+e.state.params.get("paymentId"),d=+e.state.params.get("sSI"),l=+e.state.params.get("sId"),u=e.state.params.get("o"),p=e.state.params.get("userId");if(p){const t=[];t.push([{text:`Заказы from User ${p}`,callback_data:`myO/${p}`}]),t.push([{text:"⬅️ Назад",callback_data:`${e.session.pathOrderCurrent?e.session.pathOrderCurrent:`orders?o=${u}`}`}]),await ne[0](e,`User <a href="tg://user?id=${p}">${p}</a>`,t)}const m=e.state.params.get("eP");if(e.state.params.get("sP")){const r=await de.findRecord(`objects/${u}/carts/${e.from.id}`,"products");await Promise.all([de.createRecord(`users/${e.from.id}/`,{session:{orderData:null}}),de.createRecord(`objects/${u}/carts/${e.from.id}`,{products:null}),de.updateRecord(`objects/${u}/orders/${a}`,{products:r})]),e.state.routeName="orders",e.state.param=a,await $e(e,t)}if(m){const r=await de.findRecord(`objects/${u}/orders/${a}`);await le.clear(u,e.from.id),await de.createRecord(`users/${e.from.id}`,{session:{orderData:{id:r.id,orderNumber:r.orderNumber,lastName:r.lastName,firstName:r.firstName}}}),await de.createRecord(`objects/${u}/carts/${e.from.id}`,{products:r.products}),e.state.routeName="cart",await ie(e,t)}if("showStatuses"===a){const t=+e.state.params.get("selectedStatus"),a=[];de.statuses().forEach(((e,r)=>{r===t&&(e="✅ "+e),a.push([{text:e,callback_data:`orders?statusId=${r}&o=${u}`}])})),a.push([{text:"⬅️ Назад",callback_data:`${e.session.pathOrder?e.session.pathOrder:`orders?o=${u}`}`}]),await ne[0](e,"Статуc заказа",a)}if(r){const t=await de.findRecord(`objects/${u}/orders/${a}`);e.session.orderId=a,e.session.objectId=u,e.session.fieldName=r,e.session.fieldValue=t[r],await be[0](e)}if(i){const t=[];de.payments().forEach(((e,r)=>{r===i&&(e="✅ "+e),t.push([{text:e,callback_data:`eO/${a}?paymentId=${r}&o=${u}`}])})),t.push([{text:"⬅️ Назад",callback_data:`orders/${a}?o=${u}`}]),await ne[0](e,"Способ оплаты",t)}if(n&&(await de.updateRecord(`objects/${u}/orders/${a}`,{paymentId:n}),e.state.routeName="orders",await $e(e,t)),o){const t=[];de.carriers().forEach(((e,r)=>{r===o&&(e.name="✅ "+e.name),e.reqNumber?t.push([{text:e.name,callback_data:`cO/cN?cId=${r}&oId=${a}&o=${u}`+(s?"&q="+s:"")}]):t.push([{text:e.name,callback_data:`eO/${a}?sCid=${r}&o=${u}`}])})),t.push([{text:"⬅️ Назад",callback_data:`orders/${a}?o=${u}`}]),await ne[0](e,"Способ доставки",t)}if(c){if(await de.updateRecord(`objects/${u}/orders/${a}`,{carrierId:c}),de.carriers().get(c).reqNumber&&!s)return e.state.params.set("oId",a),e.state.params.set("cId",c),void await ne[1](e,"errorCurrierNumber");s?await de.updateRecord(`objects/${u}/orders/${a}`,{carrierNumber:s}):await de.updateRecord(`objects/${u}/orders/${a}`,{carrierNumber:null}),e.state.routeName="orders",await $e(e,t)}if(d){const t=[];de.statuses().forEach(((e,r)=>{r===d&&(e="✅ "+e),t.push([{text:e,callback_data:`eO/${a}?sId=${r}&o=${u}`}])})),t.push([{text:"⬅️ Назад",callback_data:`orders/${a}?o=${u}`}]),await ne[0](e,"Статус заказа",t)}l&&(await de.updateRecord(`objects/${u}/orders/${a}`,{statusId:l}),e.state.routeName="orders",await $e(e,t)),await e.answerCbQuery()}}));var he=me,fe=be,ge=L,we=Q,ye=G,_e=H,Ie=(Re=R("3qHa4")).store,je=Re.photoCheckUrl;const ke=new v(process.env.BOT_TOKEN,{handlerTimeout:54e4});ke.use(O()),ke.use(S),ke.use((async(e,t)=>(e.callbackQuery&&"data"in e.callbackQuery&&process.env.FUNCTIONS_EMULATOR&&console.log("=============callbackQuery happened",e.callbackQuery.data.length,e.callbackQuery.data),void 0===e.session&&(e.session={}),t()))),ke.action(/^([a-zA-Z0-9-_]+)\/?([a-zA-Z0-9-_]+)?\??([a-zA-Z0-9-_=&\/:~+]+)?/,M,...q,...ye,...he,...W,...K),ke.start((async e=>{const t=e.message.text.match(/o_([a-zA-Z0-9-_]+)_p_([a-zA-Z0-9-_]+)/),a=e.message.text.match(/o_([a-zA-Z0-9-_]+)_c_([a-zA-Z0-9-_]+)/),r=[];let o="";if(t){const e=t[2],a=t[1],s=await Ie.findRecord(`objects/${a}/products/${e}`),c=await Ie.findRecord(`objects/${a}`);c&&(s?r.push([{text:`📦 ${s.name} (${s.id})`,callback_data:`p/${s.id}?o=${a}`}]):r.push([{text:"🗂 Каталог товаров",callback_data:`c?o=${a}`}]),o=`<b>${c.name}\nКонтакты: ${c.phoneArray.join()}\nАдрес: ${c.address}\nОписание: ${c.description}</b>`)}if(a){const e=a[2],t=a[1],s=await Ie.findRecord(`objects/${t}/catalogs/${e}`),c=await Ie.findRecord(`objects/${t}`);c&&(s?r.push([{text:`🗂 ${s.name}`,callback_data:`c/${e}?o=${t}`}]):r.push([{text:"🗂 Каталог товаров",callback_data:`c?o=${t}`}]),o=`<b>${c.name}\nКонтакты: ${c.phoneArray.join()}\nАдрес: ${c.address}\nОписание: ${c.description}</b>`)}if(o){const t=await je();await e.replyWithPhoto(t,{caption:o,parse_mode:"html",reply_markup:{inline_keyboard:r}})}else await U(e);await Ie.findRecord(`users/${e.from.id}`)||await Ie.createRecord(`users/${e.from.id}`,{firstName:e.from.first_name,message:e.message.text})})),ke.command("objects",(async e=>{await U(e)})),ke.command("mono",(async e=>{await F(e)})),ke.on(["text","contact"],(async e=>{if("editOrder"===e.session.scene)return void await fe[e.session.cursor](e);if("Отмена"===e.message.text)return await e.reply("Для продолжения нажмите /objects",{reply_markup:{remove_keyboard:!0}}),await Ie.createRecord(`users/${e.from.id}`,{session:{scene:null}}),void(e.session.scene=null);const t=e.state.isAdmin&&e.message.text&&e.message.text.match(/d\/(.*)\//);if(t)return await Ie.createRecord(`users/${e.from.id}`,{session:{sheetId:t[1]}}),void await X(e,t[1]);const a=await Ie.findRecord(`users/${e.from.id}`,"session");if(a&&"wizardOrder"===a.scene)await _e[a.cursor](e);else if(a&&"search"===a.scene){const t=r(process.env.ALGOLIA_ID,process.env.ALGOLIA_ADMIN_KEY).initIndex("products"),a=[];try{const r=await t.search(e.message.text);for(const e of r.hits){const t={text:`${e.objectID} ${e.name} ${e.price} ${e.currency}`,callback_data:`p/${e.objectID}?o=absemetov`};a.push([t])}await e.reply(`Search resalts: ${r.nbHits}`,{reply_markup:{inline_keyboard:a}})}catch(t){await e.reply(`Algolia error: ${t}`)}}else await e.reply("session scene is null")})),ke.on("photo",(async e=>{const t=await Ie.findRecord(`users/${e.from.id}`,"session");return t&&"uploadPhotoProduct"===t.scene?(await e.reply("uploadPhotoProduct start"),void await ge(e,t.objectId,t.productId)):t&&"uploadPhotoCat"===t.scene?(await e.reply("uploadPhotoCat start"),void await we(e,t.objectId,t.catalogId)):t&&"uploadPhotoObj"===t.scene?(await e.reply("uploadPhotoObj start"),void await D(e,t.objectId)):void await e.reply("session scene is null")})),ke.catch((e=>{if(e instanceof Error&&e.message.includes("message is not modified"))return!1;console.log("Telegraf error",e)}));e.region("europe-central2").runWith({timeoutSeconds:540,memory:"1GB"}).https.onRequest((async(e,t)=>{try{process.env.FUNCTIONS_EMULATOR?await ke.launch():await ke.handleUpdate(e.body)}finally{t.status(200).end()}}));var Ne=d.resolve(__dirname,"../sites/rzk.com.ru");const xe=t.storage().bucket();var Re,ve=(Re=R("3qHa4")).store,Oe=Re.cart,Ce=Re.roundNumber,Ae=f.createHash,Ee=f.createHmac;const Pe=b.json(),Be={i18n:new I({directory:d.resolve(Ne,"locales"),templateData:{pluralize:I.pluralize,uppercase:e=>e.toUpperCase()}}).createContext(process.env.BOT_LANG).repository[process.env.BOT_LANG],lang:process.env.BOT_LANG,currency:process.env.BOT_CURRENCY,gtag:process.env.SITE_GTAG,gmaps:process.env.BOT_GMAPS,botName:process.env.BOT_NAME,phoneregexp:process.env.BOT_PHONEREGEXP,phonetemplate:process.env.BOT_PHONETEMPLATE,domain:process.env.BOT_SITE,devPrefix:process.env.ALGOLIA_PREFIX},Te=b();Te.use(_({origin:!0})),Te.use(w());const qe=h.create({extname:".hbs"});Te.engine("hbs",qe.engine),Te.set("view engine","hbs"),Te.set("views","./sites/rzk.com.ru/views");const Ue=(e,t,a)=>{e.user={};try{const t=e.cookies.__session,a=g.verify(t,process.env.BOT_TOKEN);e.user.auth=a.auth,e.user.uid=a.uid,e.user.firstName=a.firstName}catch{e.user.auth=!1,e.user.uid=null}return Be.user=e.user,a()};Te.get("/",Ue,(async(e,t)=>{const a=await ve.findAll("objects");for(const t of a)t.cartInfo=await Oe.cartInfo(t.id,e.user.uid),t.photoId?(t.img1=xe.file(`photos/o/${t.id}/logo/${t.photoId}/1.jpg`).publicUrl(),t.img2=xe.file(`photos/o/${t.id}/logo/${t.photoId}/2.jpg`).publicUrl()):(t.img1="/icons/shop.svg",t.img2="/icons/shop.svg");t.render("index",{objects:a,envSite:Be})})),Te.get("/search",Ue,(async(e,t)=>{t.render("search",{envSite:Be})})),Te.get("/o/:objectId",Ue,(async(e,t)=>{const a=await ve.findRecord(`objects/${e.params.objectId}`);if(!a)return t.status(404).send("<h1>Object does not exist</h1>");a.cartInfo=await Oe.cartInfo(a.id,e.user.uid),a.photoId?(a.img1=xe.file(`photos/o/${a.id}/logo/${a.photoId}/1.jpg`).publicUrl(),a.img2=xe.file(`photos/o/${a.id}/logo/${a.photoId}/2.jpg`).publicUrl()):(a.img1="/icons/shop.svg",a.img2="/icons/shop.svg"),t.render("object",{title:a.name,object:a,envSite:Be})})),Te.get("/o/:objectId/c/:catalogId?",Ue,(async(e,a)=>{const r=e.params.objectId,o=e.params.catalogId,s=e.query.tag,c=e.query.startAfter,i=e.query.endBefore,n=await ve.findRecord(`objects/${r}`),d=await ve.findRecord(`objects/${r}/catalogs/${o}`);let l=`Каталог - ${n.name}`;const u=[],p=[];if(!s){(await t.firestore().collection("objects").doc(r).collection("catalogs").where("parentId","==",o||null).orderBy("orderNumber").get()).docs.forEach((e=>{const t={id:e.id,name:e.data().name,url:`/o/${n.id}/c/${e.id}`};e.data().photoId?(t.img1=xe.file(`photos/o/${n.id}/c/${e.id}/${e.data().photoId}/1.jpg`).publicUrl(),t.img2=xe.file(`photos/o/${n.id}/c/${e.id}/${e.data().photoId}/2.jpg`).publicUrl()):(t.img1="/icons/folder2.svg",t.img2="/icons/folder2.svg"),u.push(t)}))}const m=[],$=[];if(d||s){let a=t.firestore().collection("objects").doc(r).collection("products");if(d){l=`${d.name} - ${n.name}`,a=a.where("catalog.id","==",d.id);for(const e of d.tags||[]){const t={text:`${e.name}`,url:`/o/${n.id}/c/${d.id}?tag=${e.id}`};e.id===s&&(l=`${d.name} - ${e.name} - ${n.name}`,t.active=!0),p.push(t)}}a=a.orderBy("orderNumber");let o="";s&&(a=a.where("tags","array-contains",s),o=`&tag=${s}`);let u=a;if(c){const e=await t.firestore().collection("objects").doc(r).collection("products").doc(c).get();u=u.startAfter(e)}if(i){const e=await t.firestore().collection("objects").doc(r).collection("products").doc(i).get();u=u.endBefore(e).limitToLast(12)}else u=u.limit(12);const b=await u.get();for(const t of b.docs){const a={id:t.id,name:t.data().name,brand:t.data().brand?t.data().brand:null,price:Ce(t.data().price*n.currencies[t.data().currency]),unit:t.data().unit,url:`/o/${r}/p/${t.id}`,img1:"/icons/flower3.svg",img2:"/icons/flower3.svg",sellerId:r};if(e.user.uid){const o=await ve.findRecord(`objects/${r}/carts/${e.user.uid}`,`products.${t.id}`);o&&(a.qty=o.qty,a.sum=Ce(o.qty*o.price))}if(t.data().mainPhoto&&(a.img1=xe.file(`photos/o/${r}/p/${t.id}/${t.data().mainPhoto}/1.jpg`).publicUrl(),a.img2=xe.file(`photos/o/${r}/p/${t.id}/${t.data().mainPhoto}/2.jpg`).publicUrl()),m.push(a),!p.length&&s){const e={text:`Global ${t.data().tagsNames.find((e=>e.id===s)).name}`,url:`/o/${n.id}/c?tag=${s}`,global:!0};l=`Каталог - ${t.data().tagsNames.find((e=>e.id===s)).name} - ${n.name}`,e.active=!0,p.push(e)}}if(!b.empty){const e=b.docs[0],t=await a.endBefore(e).limitToLast(1).get();$.push({text:Be.i18n.aPagPrevious,icon:"bi-chevron-left",show:t.empty,url:`/o/${n.id}/c${d?`/${d.id}`:""}?endBefore=${e.id}${o}`});const r=b.docs[b.docs.length-1],s=await a.startAfter(r).limit(1).get();console.log(t.empty,s.empty),$.push({text:Be.i18n.aPagNext,icon:"bi-chevron-right",show:s.empty,url:`/o/${n.id}/c${d?`/${d.id}`:""}?startAfter=${r.id}${o}`})}}n.cartInfo=await Oe.cartInfo(n.id,e.user.uid),a.render("catalog",{title:l,object:n,currentCatalog:d,catalogs:u,products:m,tags:p,prevNextLinks:$,envSite:Be})})),Te.post("/o/:objectId/p/:productId",Ue,(async(e,t)=>{const a=e.params.objectId,r=e.params.productId,o=await ve.findRecord(`objects/${a}`),s=await ve.findRecord(`objects/${a}/products/${r}`),c={};if(c.id=r,c.name=s.name,c.unit=s.unit,c.price=Ce(s.price*o.currencies[s.currency]),e.user.uid){const t=await ve.findRecord(`objects/${a}/carts/${e.user.uid}`,`products.${s.id}`);t&&(c.qty=t.qty,c.sum=Ce(t.qty*s.price))}const i=await Oe.cartInfo(a,e.user.uid);return t.json({...c,cartInfo:i})})),Te.get("/o/:objectId/p/:productId",Ue,(async(e,t)=>{const a=e.params.objectId,r=e.params.productId,o=await ve.findRecord(`objects/${a}`),s=await ve.findRecord(`objects/${a}/products/${r}`);s.price=Ce(s.price*o.currencies[s.currency]),s.img1="/icons/flower3.svg",s.img2="/icons/flower3.svg",s.sellerId=a;const c=[];if(e.user.uid){const t=await ve.findRecord(`objects/${a}/carts/${e.user.uid}`,`products.${s.id}`);t&&(s.qty=t.qty,s.sum=Ce(t.qty*s.price))}if(s.mainPhoto){s.img1=xe.file(`photos/o/${a}/p/${s.id}/${s.mainPhoto}/1.jpg`).publicUrl(),s.img2=xe.file(`photos/o/${a}/p/${s.id}/${s.mainPhoto}/2.jpg`).publicUrl();for(const e of s.photos)if(s.mainPhoto!==e){const t=xe.file(`photos/o/${a}/p/${s.id}/${e}/1.jpg`).publicUrl(),r=xe.file(`photos/o/${a}/p/${s.id}/${e}/2.jpg`).publicUrl();c.push({img1:t,img2:r})}}o.cartInfo=await Oe.cartInfo(o.id,e.user.uid),t.render("product",{title:`${s.name} - ${o.name}`,description:`${s.name} - ${o.name}`,keywords:`${s.name}, ${o.name}`,object:o,product:s,photos:c,envSite:Be})})),Te.get("/o/:objectId/s/:orderId",Ue,(async(e,t)=>{const a=e.params.objectId,r=e.params.orderId,o=await ve.findRecord(`objects/${a}`);o.cartInfo=await Oe.cartInfo(o.id,e.user.uid);const s=await ve.findRecord(`objects/${a}/orders/${r}`);if(s){const e={orderNumber:ve.formatOrderNumber(s.userId,s.orderNumber),lastName:s.lastName,firstName:s.firstName,createdAt:$.unix(s.createdAt).locale(process.env.BOT_LANG).fromNow(),status:ve.statuses().get(s.statusId)};let r=0,c=0;const i=[];return ve.sort(s.products).forEach(((e,t)=>{i.push({index:t+1,name:e.name,id:e.id,price:e.price,qty:e.qty,unit:e.unit,sum:Ce(e.price*e.qty),url:`/o/${a}/p/${e.id}`}),r+=e.qty,c+=e.qty*e.price})),t.render("share-order",{title:`${Be.i18n.order()} #${e.orderNumber} - ${o.name}`,object:o,shareOrder:e,products:i,totalQty:r,totalSum:Ce(c),envSite:Be})}t.send("Order not found")})),Te.get("/o/:objectId/share-cart/:cartId",Ue,(async(e,t)=>{const a=e.params.objectId,r=e.params.cartId,o=await ve.findRecord(`objects/${a}`);o.cartInfo=await Oe.cartInfo(o.id,e.user.uid);const s=await ve.findRecord(`objects/${a}/carts/${r}`),c=ve.sort(s.products);if(c.length){const e=[];let i=0,n=0;return c.forEach(((t,r)=>{e.push({index:r+1,name:t.name,id:t.id,price:t.price,qty:t.qty,unit:t.unit,sum:Ce(t.price*t.qty),url:`/o/${a}/p/${t.id}`}),i+=t.qty,n+=t.qty*t.price})),t.render("share-cart",{title:`${Be.i18n.aCart()} #${r} - ${o.name}`,object:o,cartId:r,updatedAt:$.unix(s.updatedAt).locale(process.env.BOT_LANG).fromNow(),products:e,totalQty:i,totalSum:Ce(n),envSite:Be})}t.send("Cart not found")}));Te.get("/login/:objectId?",Ue,(async(e,t)=>{const a=e.params.objectId,r=e.query.r;if(e.query&&(({hash:e,...t})=>{const a=Ae("sha256").update(process.env.BOT_TOKEN).digest(),r=Object.keys(t).sort().map((e=>`${e}=${t[e]}`)).join("\n");return Ee("sha256",a).update(r).digest("hex")===e})(e.query)){if(e.user.uid){const t=await ve.findAll("objects");for(const a of t){const t=await ve.findRecord(`objects/${a.id}/carts/${e.user.uid}`,"products"),r=await ve.findRecord(`objects/${a.id}/carts/${e.query.id}`,"products");t&&(r?await ve.updateRecord(`objects/${a.id}/carts/${e.query.id}`,{products:t}):await ve.createRecord(`objects/${a.id}/carts/${e.query.id}`,{products:t})),await ve.getQuery(`objects/${a.id}/carts/${e.user.uid}`).delete()}}await ve.findRecord(`users/${e.query.id}`)||await ve.createRecord(`users/${e.query.id}`,{firstName:e.query.first_name,message:"Telegram Widget login"});const r=g.sign({uid:e.query.id,auth:!0,firstName:e.query.first_name},process.env.BOT_TOKEN);return t.cookie("__session",r,{httpOnly:!0,maxAge:2592e6}).redirect(a?`/o/${a}/cart`:"/")}t.render("login",{title:Be.i18n.aLogin,envSite:Be,redirectPage:r})})),Te.get("/logout",Ue,((e,t)=>t.clearCookie("__session").redirect("/login"))),Te.get("/o/:objectId/cart",Ue,(async(e,t)=>{const a=e.params.objectId,r=await ve.findRecord(`objects/${a}`),o=[];if(r.cartInfo=await Oe.cartInfo(r.id,e.user.uid),e.user.uid){const t=await Oe.products(a,e.user.uid);for(const s of t){const t=await ve.findRecord(`objects/${a}/products/${s.id}`);if(t.price=Ce(t.price*r.currencies[t.currency]),t&&(t.img1="/icons/flower3.svg",t.img2="/icons/flower3.svg",t.mainPhoto&&(t.img1=xe.file(`photos/o/${a}/p/${t.id}/${t.mainPhoto}/1.jpg`).publicUrl(),t.img2=xe.file(`photos/o/${a}/p/${t.id}/${t.mainPhoto}/2.jpg`).publicUrl()),o.push({id:t.id,brand:t.brand?t.brand:null,name:t.name,price:t.price,unit:t.unit,qty:s.qty,sum:Ce(s.qty*t.price),url:`/o/${a}/p/${t.id}`,img1:t.img1,img2:t.img2,sellerId:a}),t.price!==s.price)){const r={[t.id]:{price:t.price}};await ve.createRecord(`objects/${a}/carts/${e.user.uid}`,{products:r})}}}t.render("cart",{cart:!0,title:`${Be.i18n.aCart()} - ${r.name}`,object:r,products:o,carriers:Array.from(ve.carriers(),(([e,t])=>({id:e,name:t.name,reqNumber:t.reqNumber?1:0}))),payments:Array.from(ve.payments(),(([e,t])=>({id:e,name:t}))),envSite:Be})})),Te.get("/o/:objectId/cart/purchase",Ue,(async(e,t)=>{const a=e.params.objectId,r=await ve.findRecord(`objects/${a}`),o=`Оформление заказа - ${r.name}`;r.cartInfo=await Oe.cartInfo(r.id,e.user.uid),t.render("purchase",{title:o,object:r,phoneregexp:process.env.BOT_PHONEREGEXP,phonetemplate:process.env.BOT_PHONETEMPLATE,carriers:Array.from(ve.carriers(),(([e,t])=>({id:e,name:t.name,reqNumber:t.reqNumber?1:0}))),payments:Array.from(ve.payments(),(([e,t])=>({id:e,name:t}))),envSite:Be})})),Te.post("/o/:objectId/cart/purchase",Ue,((e,a)=>{const r=y({headers:e.headers}),o={};r.on("field",((e,t)=>{"carrierId"!==e&&"carrierNumber"!==e&&"paymentId"!==e||(t=+t),t&&(o[e]=t)})),r.on("close",(async()=>{const r={lastName:"required|string",firstName:"required|string",phoneNumber:["required",`regex:/${process.env.BOT_PHONEREGEXP}`],address:"required|string",carrierId:"required|integer|min:0",paymentId:"required|integer|min:0",comment:"string"};o.carrierId&&ve.carriers().get(+o.carrierId).reqNumber&&(r.carrierNumber="required|integer|min:0");const c=new s(o,r,{regex:`The :attribute phone number is not in the format ${process.env.BOT_PHONETEMPLATE}`});if(c.fails())return a.status(422).json({error:{...c.errors.all()}});const i=e.params.objectId,n=await ve.findRecord(`objects/${i}/carts/${e.user.uid}`,"products");if(n){const r=e.params.objectId,s=await ve.findRecord(`objects/${r}`),c=t.firestore().collection("objects").doc(r).collection("orders").doc(),i=e.user.auth?+e.user.uid:94899148;await ve.createRecord(`users/${i}`,{orderCount:t.firestore.FieldValue.increment(1)});const d=await ve.findRecord(`users/${i}`);return await c.set({userId:i,objectId:r,objectName:s.name,orderNumber:d.orderCount,statusId:1,fromBot:!1,products:n,createdAt:Math.floor(Date.now()/1e3),...o}),await Oe.clear(r,e.user.uid),a.json({orderId:c.id,objectId:r})}return a.status(422).json({error:"Cart empty!"})})),r.end(e.rawBody)})),Te.post("/o/:objectId/cart/add",Ue,Pe,(async(e,a)=>{const r=e.params.objectId,{productId:o,qty:c,added:i}=e.body,n=new s(e.body,{qty:"required|integer|min:0"});if(n.fails()){let e="";for(const[t,a]of Object.entries(n.errors.all()))e+=`Key ${t} => ${a} \n`;return a.status(422).json({error:e})}if(!e.user.uid){const o=t.firestore().collection("objects").doc(r).collection("carts").doc(),s=g.sign({uid:o.id,auth:!1},process.env.BOT_TOKEN);e.user.uid=o.id,e.user.auth=!1,a.cookie("__session",s,{httpOnly:!0,maxAge:2592e6})}const d=await ve.findRecord(`objects/${r}`),l=await ve.findRecord(`objects/${r}/products/${o}`),u=l.price=Ce(l.price*d.currencies[l.currency]);await Oe.add(r,e.user.uid,i?l.id:l,c);const p=await Oe.cartInfo(r,e.user.uid);return a.json({cartInfo:p,price:u})})),Te.get("/delivery-info",((e,t)=>{t.render("delivery",{envSite:Be,title:Be.i18n.aDelivery,carriers:Array.from(ve.carriers(),(([e,t])=>({id:e,name:t.name,reqNumber:t.reqNumber?1:0}))),payments:Array.from(ve.payments(),(([e,t])=>({id:e,name:t})))})})),Te.get("/return-policy",((e,t)=>{t.render("return_"+process.env.BOT_LANG,{envSite:Be,title:Be.i18n.aReturn})})),Te.get("*",((e,t)=>{t.status(404).send("<h1>404! Page not found</h1>")}));e.runWith({timeoutSeconds:540,memory:"1GB"}).https.onRequest(Te),R("2WYzv"),e.https.onRequest(((t,a)=>{e.logger.info("Hello logs!",{structuredData:!0}),a.send("Hello from Firebase!")}));